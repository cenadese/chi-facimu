<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Facimu - Eventi della Zona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        // Suppress all Tailwind warnings in production
        const originalConsole = {
            warn: console.warn,
            error: console.error,
            log: console.log
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('cdn.tailwindcss.com') || 
                message.includes('production') || 
                message.includes('Tailwind') ||
                message.includes('challenge-platform')) {
                return;
            }
            originalConsole.warn.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('challenge-platform') || 
                message.includes('netlify.app') ||
                message.includes('ERR_ABORTED 404')) {
                return;
            }
            originalConsole.error.apply(console, args);
        };
        
        // Test immediato per verificare che JavaScript funzioni
        console.log('🚀 Chi Facimu - App caricata!');
        window.addEventListener('load', function() {
            console.log('✅ Pagina completamente caricata');
            setTimeout(() => {
                console.log('📱 App inizializzata correttamente');
            }, 1000);
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400;1,500;1,600&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
        .gradient-location { background: linear-gradient(135deg, #f093fb 0%, #f093fb 50%, #c084fc 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .logo-font { font-family: 'Playfair Display', serif; font-style: italic; }
        .focus-purple:focus { ring-color: #805ad5; border-color: #805ad5; }
        .text-purple-custom { color: #805ad5; }
        .bg-purple-custom { background-color: #805ad5; }
        .hover-purple-custom:hover { background-color: #6b46c1; }
        .upload-area { border: 2px dashed #805ad5; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #6b46c1; background-color: #f7fafc; }
        .upload-area.dragover { border-color: #6b46c1; background-color: #edf2f7; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Custom scrollbar for admin panel */
        .admin-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .admin-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .admin-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .admin-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Admin Panel Toggle -->
    <div class="fixed top-4 right-4 z-50">
        <button id="adminToggle" class="bg-gray-800 text-white p-2 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            </svg>
        </button>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Accesso Admin</h2>
                    <p class="text-gray-600">Inserisci la password per accedere al pannello di gestione</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password Admin</label>
                        <input type="password" id="adminPassword" placeholder="Inserisci password..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <div id="loginError" class="hidden mt-2 text-sm text-red-600">Password non corretta</div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="adminLoginBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200">
                            Accedi
                        </button>
                        <button id="cancelAdminLogin" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-colors duration-200">
                            Annulla
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button id="resetPasswordBtn" class="w-full text-sm text-purple-600 hover:text-purple-800 font-medium transition-colors duration-200">
                            🔓 Password dimenticata? Ripristina password predefinita
                        </button>
                    </div>

                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full h-full max-h-screen overflow-y-auto admin-scroll">
            <!-- Sticky Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Admin Panel</h2>
                    <div class="flex items-center space-x-3">
                        <button id="logoutAdmin" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                            </svg>
                            <span>Logout</span>
                        </button>
                        <button id="closeAdmin" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="p-6 pt-0">

                <!-- API Configuration -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">🔑 Configurazione API</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Service Account Email</label>
                                <input type="email" id="serviceAccountEmail" placeholder="nome@progetto.iam.gserviceaccount.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sheet ID</label>
                                <input type="text" id="sheetId" placeholder="ID del Google Sheet..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Service Account Private Key</label>
                            <textarea id="serviceAccountKey" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent font-mono text-xs"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Copia la chiave privata dal file JSON scaricato (campo "private_key")</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key (per OCR)</label>
                            <input type="password" id="openaiApiKey" placeholder="sk-..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        </div>
                        <div class="flex space-x-4">
                            <button id="saveConfig" class="bg-purple-custom hover-purple-custom text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Salva Configurazione
                            </button>
                            <button id="uploadJsonBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                📁 Carica File JSON
                            </button>
                            <input type="file" id="jsonFileInput" accept=".json" class="hidden">
                        </div>
                    </div>
                </div>

                <!-- Image Upload for Event Extraction -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">📸 Carica Programma Eventi</h3>
                    <div id="uploadArea" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                        <svg class="w-12 h-12 mx-auto text-purple-custom mb-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-700 mb-2">Trascina qui l'immagine del programma</p>
                        <p class="text-sm text-gray-500">o clicca per selezionare un file</p>
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                    </div>
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-purple-custom h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600 mt-2">Elaborazione in corso...</p>
                    </div>
                </div>

                <!-- Extracted Events Preview -->
                <div id="extractedEvents" class="hidden mb-8">
                    <h3 class="text-lg font-semibold mb-4">📋 Eventi Estratti</h3>
                    <div id="eventsPreview" class="space-y-4 max-h-64 overflow-y-auto">
                        <!-- Extracted events will appear here -->
                    </div>
                    <div class="flex space-x-4 mt-4">
                        <button id="approveEvents" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            ✅ Approva e Carica
                        </button>
                        <button id="editEvents" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            ✏️ Modifica
                        </button>
                    </div>
                </div>

                <!-- Featured Event Management -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">⭐ Eventi in Primo Piano</h3>
                    
                    <!-- Master Featured Event -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="text-sm font-medium text-purple-800">Evento Master (globale):</span>
                            </div>
                            <button id="clearMasterFeatured" class="text-purple-600 hover:text-purple-800 text-sm font-medium">Rimuovi</button>
                        </div>
                        <div id="currentMasterFeatured" class="text-sm text-purple-700 mb-3">Nessun evento master</div>
                        <div class="flex space-x-3">
                            <select id="masterFeaturedEventSelect" class="flex-1 px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Seleziona evento master...</option>
                            </select>
                            <button id="setMasterFeatured" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Imposta Master
                            </button>
                        </div>
                        <p class="text-xs text-purple-600 mt-2">L'evento master appare quando nessuna città è selezionata nei filtri</p>
                    </div>

                    <!-- City Featured Events -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-3">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <span class="text-sm font-medium text-yellow-800">Eventi per Città:</span>
                        </div>
                        
                        <!-- Current City Featured Events List -->
                        <div id="cityFeaturedList" class="mb-4 space-y-2">
                            <!-- City featured events will be populated here -->
                        </div>
                        
                        <!-- Add New City Featured Event -->
                        <div class="border-t border-yellow-300 pt-3">
                            <div class="flex space-x-3 mb-2">
                                <select id="cityFeaturedCitySelect" class="flex-1 px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="">Seleziona città...</option>
                                </select>
                                <select id="cityFeaturedEventSelect" class="flex-1 px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="">Seleziona evento...</option>
                                </select>
                                <button id="setCityFeatured" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                    Aggiungi
                                </button>
                            </div>
                            <p class="text-xs text-yellow-600">Ogni città può avere un evento in primo piano che appare quando quella città è selezionata</p>
                        </div>
                    </div>
                </div>

                <!-- Manual Event Addition -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">➕ Aggiungi Evento Manualmente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="manualTitle" placeholder="Titolo evento..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        <input type="date" id="manualDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        <input type="time" id="manualTime" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        <input type="text" id="manualLocation" placeholder="Luogo..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        <select id="manualCity" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                            <option value="">Seleziona città...</option>
                            <option value="Palermo">Palermo</option>
                            <option value="Catania">Catania</option>
                            <option value="Messina">Messina</option>
                            <option value="Siracusa">Siracusa</option>
                            <option value="Trapani">Trapani</option>
                            <option value="Agrigento">Agrigento</option>
                            <option value="Ragusa">Ragusa</option>
                            <option value="Caltanissetta">Caltanissetta</option>
                            <option value="Enna">Enna</option>
                            <option value="Taormina">Taormina</option>
                            <option value="Cefalù">Cefalù</option>
                            <option value="Marsala">Marsala</option>
                            <option value="Modica">Modica</option>
                            <option value="Noto">Noto</option>
                            <option value="Sciacca">Sciacca</option>
                        </select>
                        <select id="manualCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                            <option value="">Seleziona categoria...</option>
                            <option value="Musica">🎵 Musica</option>
                            <option value="Arte">🎨 Arte</option>
                            <option value="Sport">⚽ Sport</option>
                            <option value="Cultura">📚 Cultura</option>
                            <option value="Food">🍽️ Food & Drink</option>
                        </select>
                        <textarea id="manualDescription" placeholder="Descrizione..." class="md:col-span-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent" rows="3"></textarea>
                        <input type="text" id="manualOrganizer" placeholder="Organizzatore..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                        <input type="text" id="manualPrice" placeholder="Prezzo..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent">
                    </div>
                    <button id="addManualEvent" class="mt-4 bg-purple-custom hover-purple-custom text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Aggiungi Evento
                    </button>
                </div>

                <!-- Session Management -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">🔐 Gestione Sessioni</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-3 mb-4">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-blue-900 mb-1">Sessione Corrente</h4>
                                <p class="text-sm text-blue-800">Informazioni sulla tua sessione admin attiva</p>
                            </div>
                        </div>
                        
                        <div id="currentSessionInfo" class="bg-white rounded-lg p-4 border border-blue-300 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <strong class="text-blue-900">ID Sessione:</strong>
                                    <div id="sessionId" class="text-blue-700 font-mono text-xs mt-1">Caricamento...</div>
                                </div>
                                <div>
                                    <strong class="text-blue-900">Inizio Sessione:</strong>
                                    <div id="sessionStart" class="text-blue-700 mt-1">Caricamento...</div>
                                </div>
                                <div>
                                    <strong class="text-blue-900">Ultima Attività:</strong>
                                    <div id="lastActivity" class="text-blue-700 mt-1">Caricamento...</div>
                                </div>
                                <div>
                                    <strong class="text-blue-900">Scadenza:</strong>
                                    <div id="sessionExpiry" class="text-blue-700 mt-1">Caricamento...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mb-4">
                            <button id="extendSessionBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <span>Estendi Sessione</span>
                            </button>
                            <button id="refreshSessionBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                                <span>Aggiorna Info</span>
                            </button>
                            <button id="logoutAllSessionsBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                                </svg>
                                <span>Termina Tutte</span>
                            </button>
                        </div>
                        
                        <div class="bg-gray-100 border border-gray-300 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-900 mb-2">📊 Sessioni Attive</h5>
                            <div id="allSessionsList" class="space-y-2">
                                <!-- Sessions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Password Management -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">🔑 Gestione Password</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start space-x-3 mb-4">
                            <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-yellow-900 mb-1">Sicurezza Admin</h4>
                                <p class="text-sm text-yellow-800">Cambia la password predefinita per proteggere l'accesso al pannello admin</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">Password Attuale</label>
                                    <input type="password" id="currentPassword" placeholder="Password attuale..." class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">Nuova Password</label>
                                    <input type="password" id="newPassword" placeholder="Nuova password..." class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-yellow-800 mb-2">Conferma Nuova Password</label>
                                <input type="password" id="confirmPassword" placeholder="Conferma nuova password..." class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            </div>
                            <button id="changePasswordBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Cambia Password
                            </button>
                            <p class="text-xs text-yellow-600">
                                💡 Usa una password forte con almeno 8 caratteri, lettere maiuscole, minuscole e numeri
                            </p>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">📊 Stato Sistema</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div id="sheetsStatus" class="w-3 h-3 bg-red-400 rounded-full"></div>
                                <span class="font-medium">Google Sheets</span>
                            </div>
                            <p id="sheetsStatusText" class="text-sm text-gray-600 mt-1">Non configurato</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div id="ocrStatus" class="w-3 h-3 bg-red-400 rounded-full"></div>
                                <span class="font-medium">OCR Service</span>
                            </div>
                            <p id="ocrStatusText" class="text-sm text-gray-600 mt-1">Non configurato</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div id="cacheStatus" class="w-3 h-3 bg-green-400 rounded-full"></div>
                                <span class="font-medium">Cache</span>
                            </div>
                            <p id="cacheStatusText" class="text-sm text-gray-600 mt-1">Attivo</p>
                        </div>
                    </div>
                </div>

                <!-- Netlify Identity Management -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">👥 Gestione Utenti Netlify</h3>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-start space-x-3 mb-4">
                            <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-green-900 mb-2">Sistema di Autenticazione Professionale</h4>
                                <p class="text-sm text-green-800 mb-4">
                                    Netlify Identity fornisce un sistema di autenticazione sicuro e professionale per gestire gli admin dell'app.
                                </p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div id="netlifyUserInfo" class="hidden bg-white rounded-lg p-4 border border-green-300">
                                <h5 class="font-semibold text-green-900 mb-2">Utente Connesso</h5>
                                <div id="userDetails" class="text-sm text-green-800"></div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="netlifyLogin" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    <span>Accedi con Netlify</span>
                                </button>
                                <button id="netlifyLogout" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                                    </svg>
                                    <span>Logout Netlify</span>
                                </button>
                                <button id="netlifySignup" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                                    </svg>
                                    <span>Registrati</span>
                                </button>
                            </div>
                            
                            <div class="bg-blue-100 border border-blue-300 rounded-lg p-4">
                                <h5 class="font-semibold text-blue-900 mb-2">📋 Come Configurare</h5>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-blue-800">
                                    <li>Vai su <strong>Netlify Dashboard → Site Settings → Identity</strong></li>
                                    <li>Clicca <strong>"Enable Identity"</strong></li>
                                    <li>In <strong>"Registration preferences"</strong> seleziona <strong>"Invite only"</strong></li>
                                    <li>In <strong>"External providers"</strong> abilita Google/GitHub se desiderato</li>
                                    <li>Salva e testa il login qui sopra</li>
                                </ol>
                                <p class="text-xs text-blue-600 mt-3">
                                    ✅ <strong>Gratuito fino a 1.000 utenti/mese</strong> - Perfetto per la tua app!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Recovery -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">🔧 Ripristino Configurazione</h3>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                        <div class="flex items-start space-x-3 mb-4">
                            <svg class="w-6 h-6 text-orange-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-orange-900 mb-2">Backup e Ripristino Automatico</h4>
                                <p class="text-sm text-orange-800 mb-4">
                                    La configurazione viene salvata automaticamente in più posizioni per evitare perdite di dati.
                                </p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div id="configBackupInfo" class="bg-white rounded-lg p-4 border border-orange-300">
                                <h5 class="font-semibold text-orange-900 mb-2">Stato Backup</h5>
                                <div id="backupDetails" class="text-sm text-orange-800">
                                    Caricamento informazioni backup...
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="checkConfigBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span>Verifica Configurazione</span>
                                </button>
                                <button id="restoreConfigBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    <span>Ripristina Backup</span>
                                </button>
                                <button id="exportConfigBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M7 10l5 5 5-5z"/>
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    </svg>
                                    <span>Esporta Config</span>
                                </button>
                            </div>
                            
                            <div class="bg-blue-100 border border-blue-300 rounded-lg p-4">
                                <h5 class="font-semibold text-blue-900 mb-2">💡 Suggerimenti per Evitare Perdite</h5>
                                <ul class="list-disc list-inside space-y-1 text-sm text-blue-800">
                                    <li><strong>Usa Variabili d'Ambiente:</strong> Configura le API keys nelle impostazioni Netlify</li>
                                    <li><strong>Esporta Configurazione:</strong> Salva un backup locale del file di configurazione</li>
                                    <li><strong>Verifica Regolarmente:</strong> Controlla lo stato della connessione nell'admin panel</li>
                                    <li><strong>Backup Automatico:</strong> La configurazione viene salvata automaticamente in localStorage e sessionStorage</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deploy Guide -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">🚀 Guida al Deploy</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="font-semibold text-blue-900 mb-3">Passaggi per il Deploy su Netlify:</h4>
                        <ol class="list-decimal list-inside space-y-2 text-sm text-blue-800">
                            <li><strong>Salva il file:</strong> Salva questo codice come <code class="bg-blue-100 px-1 rounded">index.html</code></li>
                            <li><strong>Crea account Netlify:</strong> Vai su <a href="https://netlify.com" target="_blank" class="underline">netlify.com</a> e registrati</li>
                            <li><strong>Deploy:</strong> Trascina il file <code class="bg-blue-100 px-1 rounded">index.html</code> nell'area di deploy di Netlify</li>
                            <li><strong>Crea Service Account:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Vai su <a href="https://console.cloud.google.com" target="_blank" class="underline">Google Cloud Console</a></li>
                                    <li>Abilita <strong>Google Sheets API</strong></li>
                                    <li>Vai su <strong>IAM → Service Accounts → Crea Service Account</strong></li>
                                    <li>Scarica il file JSON delle credenziali</li>
                                </ul>
                            </li>
                            <li><strong>Configura Google Sheet:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Crea un nuovo Google Sheet chiamato esattamente <strong>"Sheet1"</strong></li>
                                    <li>Nella prima riga (header) inserisci: <code class="bg-blue-100 px-1 rounded text-xs">Titolo | Data | Ora | Luogo | Città | Lat | Lng | Categoria | Descrizione | Organizzatore | Prezzo | Emoji</code></li>
                                    <li><strong>Importante:</strong> Condividi il sheet con l'email del Service Account (dal file JSON)</li>
                                    <li>Dai permessi di <strong>"Editor"</strong> al Service Account</li>
                                    <li>Copia l'ID del foglio dall'URL (la parte lunga dopo /spreadsheets/d/)</li>
                                </ul>
                            </li>
                            <li><strong>Ottieni OpenAI API:</strong> Vai su <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">OpenAI Platform</a> → Crea nuova API key</li>
                            <li><strong>Configura l'app:</strong> Usa il pulsante "📁 Carica File JSON" per importare automaticamente le credenziali</li>
                            <li><strong>Test:</strong> Carica un'immagine di un programma eventi per testare l'estrazione automatica</li>
                        </ol>
                        <div class="mt-4 space-y-3">
                            <div class="p-3 bg-yellow-100 border border-yellow-300 rounded">
                                <p class="text-yellow-800 text-sm"><strong>⚠️ Importante:</strong> Le API keys vengono salvate nel browser locale. Per un ambiente di produzione, considera l'uso di variabili d'ambiente server-side.</p>
                            </div>
                            
                            <div class="p-3 bg-purple-100 border border-purple-300 rounded">
                                <h6 class="font-semibold text-purple-900 mb-2">🔒 Variabili d'Ambiente Netlify</h6>
                                <p class="text-purple-800 text-sm mb-2">Per maggiore sicurezza, puoi configurare le API keys come variabili d'ambiente:</p>
                                <ol class="list-decimal list-inside text-sm text-purple-800 space-y-1">
                                    <li>Vai su <strong>Netlify Dashboard → Site Settings → Environment Variables</strong></li>
                                    <li>Aggiungi: <code class="bg-purple-200 px-1 rounded text-xs">GOOGLE_SERVICE_ACCOUNT_EMAIL</code></li>
                                    <li>Aggiungi: <code class="bg-purple-200 px-1 rounded text-xs">GOOGLE_SERVICE_ACCOUNT_KEY</code></li>
                                    <li>Aggiungi: <code class="bg-purple-200 px-1 rounded text-xs">GOOGLE_SHEET_ID</code></li>
                                    <li>Aggiungi: <code class="bg-purple-200 px-1 rounded text-xs">OPENAI_API_KEY</code></li>
                                </ol>
                                <p class="text-xs text-purple-600 mt-2">
                                    💡 Le variabili d'ambiente sono più sicure ma richiedono un rebuild del sito per le modifiche
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                            <circle cx="12" cy="12" r="2" fill="currentColor"/>
                            <path d="M9 16h6v1H9z" fill="currentColor"/>
                            <path d="M7 10h2v1H7zm4 0h2v1h-2zm4 0h2v1h-2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-semibold logo-font">Chi Facimu?</h1>
                        <p class="text-white text-opacity-90 text-sm font-medium">eventi della tua zona</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="syncStatus" class="flex items-center space-x-2 text-sm">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span>Sincronizzato</span>
                    </div>
                    <button id="refreshBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        <span class="font-medium">Aggiorna</span>
                    </button>
                    <button id="contactBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        <span class="font-medium">Contatti</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <!-- Search and Basic Filters -->
            <div class="flex flex-wrap gap-4 items-center mb-4">
                <div class="flex-1 min-w-64 relative">
                    <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Cerca eventi..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent text-gray-700">
                </div>
                <select id="categoryFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent text-gray-700 font-medium">
                    <option value="">Tutte le categorie</option>
                    <option value="Musica">🎵 Musica</option>
                    <option value="Arte">🎨 Arte</option>
                    <option value="Sport">⚽ Sport</option>
                    <option value="Cultura">📚 Cultura</option>
                    <option value="Food">🍽️ Food & Drink</option>
                </select>
                <select id="dateFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent text-gray-700 font-medium">
                    <option value="">Tutte le date</option>
                    <option value="today">📅 Oggi</option>
                    <option value="tomorrow">🌅 Domani</option>
                    <option value="week">📆 Questa settimana</option>
                    <option value="month">🗓️ Questo mese</option>
                </select>
            </div>

            <!-- Location Filters -->
            <div class="border-t pt-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center space-x-2">
                        <button id="geoLocationBtn" class="gradient-location text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:opacity-90 flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                            </svg>
                            <span id="geoLocationText">Usa la mia posizione</span>
                        </button>
                        <div id="geoStatus" class="hidden text-sm text-green-600 font-medium flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span>Posizione attiva</span>
                        </div>
                    </div>
                    
                    <select id="cityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent text-gray-700 font-medium">
                        <option value="">🏙️ Tutte le città</option>
                        <!-- Cities will be populated dynamically -->
                    </select>

                    <div class="flex items-center space-x-2">
                        <label for="radiusFilter" class="text-sm font-medium text-gray-700">📍 Raggio:</label>
                        <select id="radiusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus-purple focus:border-transparent text-gray-700 font-medium">
                            <option value="">Qualsiasi</option>
                            <option value="5">5 km</option>
                            <option value="10">10 km</option>
                            <option value="25">25 km</option>
                            <option value="50">50 km</option>
                            <option value="100">100 km</option>
                        </select>
                    </div>

                    <button id="clearFiltersBtn" class="text-purple-custom hover:text-purple-600 font-medium text-sm flex items-center space-x-1 transition-colors duration-200">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                        <span>Pulisci filtri</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center space-x-2">
                <div id="connectionIndicator" class="w-3 h-3 bg-orange-400 rounded-full animate-pulse"></div>
                <span id="connectionText" class="text-blue-800 font-medium">Demo Mode - Dati di esempio</span>
            </div>
            <p id="connectionSubtext" class="text-blue-600 text-sm mt-1">Configura le API nell'admin panel per collegare Google Sheets</p>
        </div>

        <!-- Featured Event -->
        <div id="featuredEvent" class="hidden mb-8">
            <!-- Featured event will be populated here -->
        </div>

        <!-- Mobile View Toggle -->
        <div class="md:hidden mb-4 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Altri Eventi</h3>
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button id="gridViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-white text-gray-900 shadow-sm">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/>
                    </svg>
                </button>
                <button id="listViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 text-gray-600">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Events Grid -->
        <div id="eventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Events will be populated here -->
        </div>

        <!-- Events List (Mobile) -->
        <div id="eventsList" class="hidden space-y-3">
            <!-- Events list will be populated here -->
        </div>

        <!-- Loading Skeleton -->
        <div id="loadingSkeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow-sm p-6 animate-pulse">
                <div class="flex items-start justify-between mb-4">
                    <div class="w-12 h-12 bg-gray-300 rounded"></div>
                    <div class="w-20 h-6 bg-gray-300 rounded-full"></div>
                </div>
                <div class="h-6 bg-gray-300 rounded mb-2"></div>
                <div class="h-4 bg-gray-300 rounded mb-4"></div>
                <div class="h-4 bg-gray-300 rounded"></div>
            </div>
        </div>

        <!-- No events message -->
        <div id="noEvents" class="text-center py-12 hidden">
            <div class="text-gray-400 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                    <path d="M12 13c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0-4c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1z"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Nessun evento trovato</h3>
            <p class="text-gray-500">Prova a modificare i filtri di ricerca</p>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-90vh overflow-y-auto">
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                            <circle cx="12" cy="12" r="2" fill="currentColor"/>
                            <path d="M9 16h6v1H9z" fill="currentColor"/>
                            <path d="M7 10h2v1H7zm4 0h2v1h-2zm4 0h2v1h-2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold logo-font">Chi Facimu?</h3>
                        <p class="text-gray-400 text-sm">eventi della tua zona</p>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm mb-2">
                        Sviluppato per amore della Calabria da
                    </p>
                    <div class="flex items-center justify-center md:justify-end space-x-2">
                        <span class="font-semibold text-white">Antonio Gallo</span>
                        <span class="text-gray-400">•</span>
                        <a href="mailto:aigallo2025@gmail.com" class="text-purple-400 hover:text-purple-300 transition-colors duration-200 font-medium">
                            aigallo2025@gmail.com
                        </a>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Chi Facimu v2.0 - Sistema Eventi Avanzato
                    </p>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-6 pt-6 text-center">
                <p class="text-gray-500 text-sm">
                    © 2025 Chi Facimu. Tutti i diritti riservati. 
                    <span class="mx-2">•</span>
                    Un progetto per valorizzare gli eventi calabresi
                </p>
            </div>
        </div>
    </footer>

    <!-- Contact Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Contatti</h2>
                    <button id="closeContact" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Antonio Gallo</h3>
                    <p class="text-gray-600 mb-4">Sviluppatore di Chi Facimu</p>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">📧 Email</h4>
                        <a href="mailto:aigallo2025@gmail.com" class="text-purple-600 hover:text-purple-800 font-medium transition-colors duration-200">
                            aigallo2025@gmail.com
                        </a>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">💼 LinkedIn</h4>
                        <a href="https://www.linkedin.com/in/antonio-gallo/" target="_blank" class="text-purple-600 hover:text-purple-800 font-medium transition-colors duration-200 flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                            <span>antonio-gallo</span>
                        </a>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">💡 Informazioni</h4>
                        <p class="text-gray-600 text-sm">
                            Chi Facimu è un'app per scoprire eventi nella tua zona in Calabria. 
                            Per segnalazioni, suggerimenti o supporto tecnico, non esitare a contattarmi!
                        </p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
                        <h4 class="font-semibold text-purple-900 mb-2">🚀 Versione</h4>
                        <p class="text-purple-700 text-sm">
                            Chi Facimu v2.0 - Sistema Eventi Avanzato<br>
                            <span class="text-xs text-purple-600">Sviluppato per amore della Calabria</span>
                        </p>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <div class="flex space-x-3">
                        <button onclick="window.open('mailto:aigallo2025@gmail.com?subject=Chi Facimu - Contatto&body=Ciao Antonio,%0A%0A', '_blank')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                            <span>Scrivi Email</span>
                        </button>
                        <button onclick="app.copyDeveloperEmail()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <button onclick="window.open('https://www.linkedin.com/in/antonio-gallo/', '_blank')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        <span>Collegati su LinkedIn</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Advanced Session Management System
        class SessionManager {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes
                this.warningTimeout = 5 * 60 * 1000; // 5 minutes warning
                this.maxSessions = 3; // Maximum concurrent sessions
                this.activityTimeout = null;
                this.warningTimeout = null;
                this.heartbeatInterval = null;
                
                this.initializeSession();
                this.setupActivityTracking();
                this.startHeartbeat();
            }

            // Generate unique session ID
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // Initialize session
            initializeSession() {
                const now = Date.now();
                const sessionData = {
                    id: this.sessionId,
                    startTime: now,
                    lastActivity: now,
                    userAgent: navigator.userAgent,
                    ipHash: this.hashIP(),
                    isActive: true
                };

                // Store session data
                sessionStorage.setItem('currentSession', JSON.stringify(sessionData));
                
                // Manage multiple sessions
                this.manageSessions(sessionData);
                
                console.log('🔐 Nuova sessione inizializzata:', this.sessionId);
            }

            // Hash IP for session tracking (privacy-friendly)
            hashIP() {
                // Simple hash of user agent + timestamp for session identification
                const data = navigator.userAgent + Date.now();
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash).toString(36);
            }

            // Manage multiple sessions
            manageSessions(newSession) {
                let sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                
                // Remove expired sessions
                const now = Date.now();
                sessions = sessions.filter(session => 
                    (now - session.lastActivity) < this.sessionTimeout
                );

                // Add new session
                sessions.push(newSession);

                // Limit concurrent sessions
                if (sessions.length > this.maxSessions) {
                    sessions = sessions.slice(-this.maxSessions);
                    console.log('⚠️ Limite sessioni raggiunto, rimosse sessioni più vecchie');
                }

                localStorage.setItem('adminSessions', JSON.stringify(sessions));
            }

            // Setup activity tracking
            setupActivityTracking() {
                const activities = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                
                const updateActivity = () => {
                    this.updateLastActivity();
                    this.resetTimeout();
                };

                activities.forEach(activity => {
                    document.addEventListener(activity, updateActivity, true);
                });

                // Initial timeout setup
                this.resetTimeout();
            }

            // Update last activity timestamp
            updateLastActivity() {
                const now = Date.now();
                const sessionData = JSON.parse(sessionStorage.getItem('currentSession') || '{}');
                
                if (sessionData.id) {
                    sessionData.lastActivity = now;
                    sessionStorage.setItem('currentSession', JSON.stringify(sessionData));
                    
                    // Update in localStorage sessions array
                    let sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                    const sessionIndex = sessions.findIndex(s => s.id === sessionData.id);
                    if (sessionIndex !== -1) {
                        sessions[sessionIndex].lastActivity = now;
                        localStorage.setItem('adminSessions', JSON.stringify(sessions));
                    }
                }
            }

            // Reset session timeout
            resetTimeout() {
                // Clear existing timeouts
                if (this.activityTimeout) clearTimeout(this.activityTimeout);
                if (this.warningTimeout) clearTimeout(this.warningTimeout);

                // Set warning timeout (5 minutes before expiry)
                this.warningTimeout = setTimeout(() => {
                    this.showSessionWarning();
                }, this.sessionTimeout - this.warningTimeout);

                // Set session expiry timeout
                this.activityTimeout = setTimeout(() => {
                    this.expireSession();
                }, this.sessionTimeout);
            }

            // Show session expiry warning
            showSessionWarning() {
                const modal = this.createWarningModal();
                document.body.appendChild(modal);
                
                // Auto-close warning after 5 minutes if no action
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                        this.expireSession();
                    }
                }, this.warningTimeout);
            }

            // Create session warning modal
            createWarningModal() {
                const modal = document.createElement('div');
                modal.id = 'sessionWarningModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-xl max-w-md w-full">
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                    </svg>
                                </div>
                                <h2 class="text-xl font-bold text-gray-900 mb-2">Sessione in Scadenza</h2>
                                <p class="text-gray-600">La tua sessione admin scadrà tra 5 minuti per inattività.</p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start space-x-3">
                                        <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                        </svg>
                                        <div>
                                            <h4 class="font-semibold text-yellow-900 mb-1">Cosa succede ora?</h4>
                                            <ul class="text-sm text-yellow-800 space-y-1">
                                                <li>• Clicca "Estendi Sessione" per continuare</li>
                                                <li>• Oppure verrai disconnesso automaticamente</li>
                                                <li>• I tuoi dati non salvati andranno persi</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3">
                                    <button onclick="app.sessionManager.extendSession()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200">
                                        Estendi Sessione
                                    </button>
                                    <button onclick="app.sessionManager.logoutNow()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200">
                                        Logout Ora
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return modal;
            }

            // Extend current session
            extendSession() {
                this.updateLastActivity();
                this.resetTimeout();
                
                // Remove warning modal
                const modal = document.getElementById('sessionWarningModal');
                if (modal) {
                    document.body.removeChild(modal);
                }
                
                app.showNotification('Sessione estesa per altri 30 minuti', 'success');
                console.log('🔄 Sessione estesa:', this.sessionId);
            }

            // Force logout
            logoutNow() {
                this.expireSession();
            }

            // Expire current session
            expireSession() {
                console.log('⏰ Sessione scaduta:', this.sessionId);
                
                // Clear session data
                this.clearSession();
                
                // Force logout
                app.isAdminAuthenticated = false;
                sessionStorage.removeItem('adminAuth');
                
                // Close admin panel
                document.getElementById('adminPanel').classList.add('hidden');
                
                // Remove warning modal if present
                const modal = document.getElementById('sessionWarningModal');
                if (modal) {
                    document.body.removeChild(modal);
                }
                
                // Show expiry notification
                app.showNotification('Sessione scaduta per inattività. Effettua nuovamente il login.', 'error');
                
                // Show login modal after a delay
                setTimeout(() => {
                    app.showAdminLogin();
                }, 2000);
            }

            // Clear session data
            clearSession() {
                // Remove from sessionStorage
                sessionStorage.removeItem('currentSession');
                
                // Remove from localStorage sessions array
                let sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                sessions = sessions.filter(session => session.id !== this.sessionId);
                localStorage.setItem('adminSessions', JSON.stringify(sessions));
                
                // Clear timeouts
                if (this.activityTimeout) clearTimeout(this.activityTimeout);
                if (this.warningTimeout) clearTimeout(this.warningTimeout);
                if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);
            }

            // Start heartbeat to detect tab/window closure
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    this.updateLastActivity();
                    this.cleanupExpiredSessions();
                }, 60000); // Every minute
                
                // Handle page unload
                window.addEventListener('beforeunload', () => {
                    this.clearSession();
                });
                
                // Handle visibility change (tab switching)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.updateLastActivity();
                        this.resetTimeout();
                    }
                });
            }

            // Cleanup expired sessions
            cleanupExpiredSessions() {
                let sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                const now = Date.now();
                
                const activeSessions = sessions.filter(session => 
                    (now - session.lastActivity) < this.sessionTimeout
                );
                
                if (activeSessions.length !== sessions.length) {
                    localStorage.setItem('adminSessions', JSON.stringify(activeSessions));
                    console.log('🧹 Sessioni scadute rimosse');
                }
            }

            // Check if user is authenticated
            isAuthenticated() {
                const sessionData = JSON.parse(sessionStorage.getItem('currentSession') || '{}');
                const adminAuth = sessionStorage.getItem('adminAuth') === 'true';
                
                if (!adminAuth || !sessionData.id) {
                    return false;
                }
                
                // Check if session is still valid
                const now = Date.now();
                if ((now - sessionData.lastActivity) > this.sessionTimeout) {
                    this.expireSession();
                    return false;
                }
                
                return true;
            }

            // Get session info
            getSessionInfo() {
                const sessionData = JSON.parse(sessionStorage.getItem('currentSession') || '{}');
                const sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                
                return {
                    current: sessionData,
                    all: sessions,
                    count: sessions.length,
                    maxSessions: this.maxSessions
                };
            }

            // Force logout all sessions
            logoutAllSessions() {
                localStorage.removeItem('adminSessions');
                sessionStorage.removeItem('currentSession');
                sessionStorage.removeItem('adminAuth');
                
                this.clearSession();
                app.isAdminAuthenticated = false;
                
                console.log('🚪 Tutte le sessioni terminate');
                app.showNotification('Tutte le sessioni sono state terminate', 'success');
            }
        }

        // Configuration and State Management
        class ChiFacimuApp {
            constructor() {
                // Try environment variables first, then localStorage
                this.config = {
                    serviceAccountEmail: this.getConfigValue('GOOGLE_SERVICE_ACCOUNT_EMAIL', 'serviceAccountEmail'),
                    serviceAccountKey: this.getConfigValue('GOOGLE_SERVICE_ACCOUNT_KEY', 'serviceAccountKey'),
                    sheetId: this.getConfigValue('GOOGLE_SHEET_ID', 'sheetId'),
                    openaiApiKey: this.getConfigValue('OPENAI_API_KEY', 'openaiApiKey')
                };
                this.accessToken = null;
                this.tokenExpiry = null;
                this.cache = new Map();
                this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
                this.userLocation = null;
                this.events = [];
                this.filteredEvents = [];
                this.lastSync = null;
                this.autoSyncInterval = null;
                this.mobileView = 'grid'; // 'grid' or 'list'
                this.masterFeaturedEventId = null;
                this.cityFeaturedEvents = new Map(); // city -> eventId
                
                // Advanced Session Management
                this.sessionManager = new SessionManager();
                this.isAdminAuthenticated = this.sessionManager.isAuthenticated();
                
                // Netlify Identity
                this.netlifyUser = null;
                
                this.initializeApp();
                this.initializeNetlifyIdentity();
            }

            // Get configuration value from environment variables or localStorage
            getConfigValue(envVar, localStorageKey) {
                // Check if running on Netlify with environment variables
                if (typeof process !== 'undefined' && process.env && process.env[envVar]) {
                    console.log(`🌍 Usando variabile d'ambiente: ${envVar}`);
                    return process.env[envVar];
                }
                
                // Check for Netlify build-time environment variables (injected at build)
                if (typeof window !== 'undefined' && window.ENV && window.ENV[envVar]) {
                    console.log(`🌍 Usando variabile build-time: ${envVar}`);
                    return window.ENV[envVar];
                }
                
                // Try localStorage first
                const localValue = localStorage.getItem(localStorageKey);
                if (localValue) {
                    console.log(`💾 Usando localStorage: ${localStorageKey}`);
                    return localValue;
                }
                
                // Try sessionStorage as fallback
                const sessionValue = sessionStorage.getItem(localStorageKey);
                if (sessionValue) {
                    console.log(`🔄 Usando sessionStorage: ${localStorageKey}`);
                    // Restore to localStorage
                    localStorage.setItem(localStorageKey, sessionValue);
                    return sessionValue;
                }
                
                console.log(`❌ Nessuna configurazione trovata per: ${localStorageKey}`);
                return '';
            }

            // Sample event data (fallback)
            getSampleEvents() {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dayAfter = new Date(today);
                dayAfter.setDate(dayAfter.getDate() + 2);
                
                return [
                    {
                        id: 1,
                        title: "Concerto Jazz al Tramonto",
                        date: today.toISOString().split('T')[0],
                        time: "20:00",
                        location: "Piazza del Duomo, Palermo",
                        city: "Palermo",
                        coordinates: { lat: 38.1157, lng: 13.3613 },
                        category: "Musica",
                        description: "Una serata magica con i migliori musicisti jazz della Sicilia. Ingresso gratuito.",
                        organizer: "Associazione Jazz Sicilia",
                        price: "Gratuito",
                        image: "🎷"
                    },
                    {
                        id: 2,
                        title: "Mostra d'Arte Contemporanea",
                        date: tomorrow.toISOString().split('T')[0],
                        time: "10:00",
                        location: "Palazzo Abatellis, Palermo",
                        city: "Palermo",
                        coordinates: { lat: 38.1080, lng: 13.3700 },
                        category: "Arte",
                        description: "Esposizione di opere di artisti siciliani emergenti. Aperta fino al 30 gennaio.",
                        organizer: "Galleria Moderna",
                        price: "€8",
                        image: "🎨"
                    },
                    {
                        id: 3,
                        title: "Sagra della Cassata",
                        date: dayAfter.toISOString().split('T')[0],
                        time: "18:00",
                        location: "Via del Corso, Palermo",
                        city: "Palermo",
                        coordinates: { lat: 38.1184, lng: 13.3623 },
                        category: "Food",
                        description: "Degustazione della tradizionale cassata siciliana con i migliori pasticceri della città.",
                        organizer: "Pro Loco Palermo",
                        price: "€12",
                        image: "🍰"
                    },
                    {
                        id: 4,
                        title: "Torneo di Calcetto",
                        date: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "16:00",
                        location: "Centro Sportivo Comunale, Catania",
                        city: "Catania",
                        coordinates: { lat: 37.5079, lng: 15.0830 },
                        category: "Sport",
                        description: "Torneo amatoriale aperto a tutti. Iscrizioni entro il 16 gennaio.",
                        organizer: "ASD Catania Sport",
                        price: "€15",
                        image: "⚽"
                    },
                    {
                        id: 5,
                        title: "Conferenza Storia Siciliana",
                        date: new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "17:30",
                        location: "Biblioteca Centrale, Messina",
                        city: "Messina",
                        coordinates: { lat: 38.1938, lng: 15.5540 },
                        category: "Cultura",
                        description: "Incontro con lo storico Prof. Rossi sulla storia medievale della Sicilia.",
                        organizer: "Università di Messina",
                        price: "Gratuito",
                        image: "📚"
                    },
                    {
                        id: 6,
                        title: "Festival della Birra Artigianale",
                        date: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "19:00",
                        location: "Foro Italico, Palermo",
                        city: "Palermo",
                        coordinates: { lat: 38.1205, lng: 13.3700 },
                        category: "Food",
                        description: "Degustazione di birre artigianali siciliane con street food locale.",
                        organizer: "Birrifici Siciliani",
                        price: "€20",
                        image: "🍺"
                    },
                    {
                        id: 7,
                        title: "Teatro Greco a Taormina",
                        date: new Date(today.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "21:00",
                        location: "Teatro Antico, Taormina",
                        city: "Taormina",
                        coordinates: { lat: 37.8536, lng: 15.2869 },
                        category: "Cultura",
                        description: "Rappresentazione classica nel suggestivo teatro greco con vista sull'Etna.",
                        organizer: "Fondazione Taormina Arte",
                        price: "€35",
                        image: "🎭"
                    },
                    {
                        id: 8,
                        title: "Mercatino dell'Antiquariato",
                        date: new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "09:00",
                        location: "Piazza Pretoria, Cefalù",
                        city: "Cefalù",
                        coordinates: { lat: 38.0390, lng: 14.0202 },
                        category: "Arte",
                        description: "Mercatino mensile con oggetti d'epoca, libri antichi e artigianato locale.",
                        organizer: "Comune di Cefalù",
                        price: "Gratuito",
                        image: "🏺"
                    },
                    {
                        id: 9,
                        title: "Degustazione Vini Marsala",
                        date: new Date(today.getTime() + 8 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "17:00",
                        location: "Cantina Florio, Marsala",
                        city: "Marsala",
                        coordinates: { lat: 37.7981, lng: 12.4358 },
                        category: "Food",
                        description: "Tour guidato nelle storiche cantine con degustazione di vini DOC.",
                        organizer: "Cantine Florio",
                        price: "€25",
                        image: "🍷"
                    },
                    {
                        id: 10,
                        title: "Festival del Cioccolato",
                        date: new Date(today.getTime() + 9 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "15:00",
                        location: "Centro Storico, Modica",
                        city: "Modica",
                        coordinates: { lat: 36.8646, lng: 14.7597 },
                        category: "Food",
                        description: "Celebrazione del famoso cioccolato di Modica con laboratori e degustazioni.",
                        organizer: "Consorzio Cioccolato Modica",
                        price: "€10",
                        image: "🍫"
                    },
                    {
                        id: 11,
                        title: "Concerto Barocco",
                        date: new Date(today.getTime() + 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "20:30",
                        location: "Duomo di Noto",
                        city: "Noto",
                        coordinates: { lat: 36.8909, lng: 15.0707 },
                        category: "Musica",
                        description: "Ensemble barocco in concerto nella splendida cattedrale patrimonio UNESCO.",
                        organizer: "Associazione Musicale Noto",
                        price: "€18",
                        image: "🎼"
                    },
                    {
                        id: 12,
                        title: "Terme e Benessere",
                        date: new Date(today.getTime() + 11 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: "10:00",
                        location: "Terme di Sciacca",
                        city: "Sciacca",
                        coordinates: { lat: 37.5077, lng: 13.0836 },
                        category: "Sport",
                        description: "Giornata di relax alle terme naturali con trattamenti benessere.",
                        organizer: "Terme di Sciacca",
                        price: "€45",
                        image: "♨️"
                    }
                ];
            }

            // Initialize the application
            initializeApp() {
                console.log('🔧 Inizializzazione componenti...');
                try {
                    this.setupEventListeners();
                    console.log('✅ Event listeners configurati');
                    
                    this.updateConnectionStatus();
                    console.log('✅ Stato connessione aggiornato');
                    
                    this.loadEvents();
                    console.log('✅ Eventi caricati');
                    
                    this.startAutoSync();
                    console.log('✅ Auto-sync avviato');
                    
                    console.log('🎉 App completamente inizializzata!');
                } catch (error) {
                    console.error('❌ Errore durante inizializzazione:', error);
                    throw error;
                }
            }

            // Setup all event listeners
            setupEventListeners() {
                // Admin panel
                document.getElementById('adminToggle').addEventListener('click', () => this.showAdminLogin());
                document.getElementById('closeAdmin').addEventListener('click', () => this.toggleAdminPanel());
                document.getElementById('logoutAdmin').addEventListener('click', () => this.logoutAdmin());
                
                // Admin login
                document.getElementById('adminLoginBtn').addEventListener('click', () => this.authenticateAdmin());
                document.getElementById('cancelAdminLogin').addEventListener('click', () => this.hideAdminLogin());
                document.getElementById('resetPasswordBtn').addEventListener('click', () => this.resetAdminPassword());
                document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.authenticateAdmin();
                });
                
                // Password change
                document.getElementById('changePasswordBtn').addEventListener('click', () => this.changeAdminPassword());
                
                // Session management
                document.getElementById('extendSessionBtn').addEventListener('click', () => this.extendSession());
                document.getElementById('refreshSessionBtn').addEventListener('click', () => this.refreshSessionInfo());
                document.getElementById('logoutAllSessionsBtn').addEventListener('click', () => this.logoutAllSessions());
                
                // Contact modal
                document.getElementById('contactBtn').addEventListener('click', () => this.toggleContactModal());
                document.getElementById('closeContact').addEventListener('click', () => this.toggleContactModal());
                document.getElementById('saveConfig').addEventListener('click', () => this.saveConfiguration());
                document.getElementById('uploadJsonBtn').addEventListener('click', () => document.getElementById('jsonFileInput').click());
                document.getElementById('jsonFileInput').addEventListener('change', (e) => this.handleJsonUpload(e));

                // Image upload
                const uploadArea = document.getElementById('uploadArea');
                const imageInput = document.getElementById('imageInput');
                
                uploadArea.addEventListener('click', () => imageInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) this.processImage(files[0]);
                });
                imageInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) this.processImage(e.target.files[0]);
                });

                // Manual event addition
                document.getElementById('addManualEvent').addEventListener('click', () => this.addManualEvent());

                // Featured event management
                document.getElementById('setMasterFeatured').addEventListener('click', () => this.setMasterFeaturedEvent());
                document.getElementById('clearMasterFeatured').addEventListener('click', () => this.clearMasterFeaturedEvent());
                document.getElementById('setCityFeatured').addEventListener('click', () => this.setCityFeaturedEvent());
                document.getElementById('cityFeaturedCitySelect').addEventListener('change', () => this.updateCityFeaturedEventSelect());

                // Configuration management
                document.getElementById('checkConfigBtn').addEventListener('click', () => this.checkConfiguration());
                document.getElementById('restoreConfigBtn').addEventListener('click', () => this.restoreConfiguration());
                document.getElementById('exportConfigBtn').addEventListener('click', () => this.exportConfiguration());

                // Event approval
                document.getElementById('approveEvents')?.addEventListener('click', () => this.approveExtractedEvents());

                // Filters
                document.getElementById('searchInput').addEventListener('input', () => this.filterEvents());
                document.getElementById('categoryFilter').addEventListener('change', () => this.filterEvents());
                document.getElementById('dateFilter').addEventListener('change', () => this.filterEvents());
                document.getElementById('cityFilter').addEventListener('change', () => this.filterEvents());
                document.getElementById('radiusFilter').addEventListener('change', () => this.filterEvents());
                document.getElementById('geoLocationBtn').addEventListener('click', () => this.getUserLocation());
                document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearAllFilters());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshEvents());

                // Mobile view toggle
                document.getElementById('gridViewBtn').addEventListener('click', () => this.toggleMobileView('grid'));
                document.getElementById('listViewBtn').addEventListener('click', () => this.toggleMobileView('list'));

                // Modal
                document.getElementById('eventModal').addEventListener('click', (e) => {
                    if (e.target.id === 'eventModal') this.closeEventModal();
                });
                
                document.getElementById('contactModal').addEventListener('click', (e) => {
                    if (e.target.id === 'contactModal') this.toggleContactModal();
                });
            }

            // Show admin login modal
            showAdminLogin() {
                if (this.isAdminAuthenticated) {
                    this.toggleAdminPanel();
                } else {
                    document.getElementById('adminLoginModal').classList.remove('hidden');
                    document.getElementById('adminPassword').focus();
                }
            }

            // Hide admin login modal
            hideAdminLogin() {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('loginError').classList.add('hidden');
            }

            // Authenticate admin
            authenticateAdmin() {
                const inputPassword = document.getElementById('adminPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                // Always get the latest password from localStorage
                const currentPassword = localStorage.getItem('adminPassword') || 'ChiFacimu2025!';
                
                if (inputPassword === currentPassword) {
                    // Initialize new session
                    this.sessionManager = new SessionManager();
                    this.isAdminAuthenticated = true;
                    sessionStorage.setItem('adminAuth', 'true');
                    
                    this.hideAdminLogin();
                    this.toggleAdminPanel();
                    this.showNotification('Accesso effettuato con successo!', 'success');
                    
                    // Show session info
                    const sessionInfo = this.sessionManager.getSessionInfo();
                    console.log('🔐 Sessione attiva:', sessionInfo.current.id);
                    console.log('📊 Sessioni totali:', sessionInfo.count + '/' + sessionInfo.maxSessions);
                } else {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();
                }
            }

            // Reset admin password to default
            resetAdminPassword() {
                if (confirm('⚠️ ATTENZIONE: Questo ripristinerà la password predefinita "ChiFacimu2025!"\n\nSei sicuro di voler continuare?')) {
                    // Reset to default password
                    localStorage.setItem('adminPassword', 'ChiFacimu2025!');
                    sessionStorage.setItem('adminPassword', 'ChiFacimu2025!');
                    
                    // Clear any existing authentication
                    this.isAdminAuthenticated = false;
                    sessionStorage.removeItem('adminAuth');
                    
                    this.showNotification('Password ripristinata a "ChiFacimu2025!" - Ora puoi accedere!', 'success');
                    
                    // Clear the password field and focus it
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();
                    document.getElementById('loginError').classList.add('hidden');
                }
            }

            // Change admin password
            changeAdminPassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showNotification('Compila tutti i campi', 'error');
                    return;
                }
                
                // Always get the latest password from localStorage
                const storedPassword = localStorage.getItem('adminPassword') || 'ChiFacimu2025!';
                
                if (currentPassword !== storedPassword) {
                    this.showNotification('Password attuale non corretta', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showNotification('Le nuove password non coincidono', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    this.showNotification('La password deve essere di almeno 8 caratteri', 'error');
                    return;
                }
                
                // Update password in localStorage immediately
                localStorage.setItem('adminPassword', newPassword);
                
                // Also update in sessionStorage for immediate effect
                sessionStorage.setItem('adminPassword', newPassword);
                
                // Force logout and require re-login with new password
                this.isAdminAuthenticated = false;
                sessionStorage.removeItem('adminAuth');
                
                // Clear form
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Close admin panel
                document.getElementById('adminPanel').classList.add('hidden');
                
                this.showNotification('Password cambiata! Effettua il login con la nuova password.', 'success');
                
                // Show login modal after a short delay
                setTimeout(() => {
                    this.showAdminLogin();
                }, 1500);
            }

            // Logout admin
            logoutAdmin() {
                // Clear session through session manager
                if (this.sessionManager) {
                    this.sessionManager.clearSession();
                }
                
                this.isAdminAuthenticated = false;
                sessionStorage.removeItem('adminAuth');
                document.getElementById('adminPanel').classList.add('hidden');
                this.showNotification('Logout effettuato', 'success');
            }

            // Initialize Netlify Identity
            initializeNetlifyIdentity() {
                if (typeof netlifyIdentity === 'undefined') {
                    console.log('Netlify Identity non disponibile');
                    return;
                }

                // Initialize Netlify Identity
                netlifyIdentity.init();

                // Check if user is already logged in
                this.netlifyUser = netlifyIdentity.currentUser();
                this.updateNetlifyUI();

                // Event listeners for Netlify Identity
                netlifyIdentity.on('init', (user) => {
                    this.netlifyUser = user;
                    this.updateNetlifyUI();
                });

                netlifyIdentity.on('login', (user) => {
                    this.netlifyUser = user;
                    this.updateNetlifyUI();
                    this.showNotification(`Benvenuto ${user.user_metadata.full_name || user.email}!`, 'success');
                    netlifyIdentity.close();
                });

                netlifyIdentity.on('logout', () => {
                    this.netlifyUser = null;
                    this.updateNetlifyUI();
                    this.showNotification('Logout Netlify effettuato', 'success');
                });

                // Setup event listeners for Netlify buttons
                document.getElementById('netlifyLogin').addEventListener('click', () => {
                    netlifyIdentity.open();
                });

                document.getElementById('netlifyLogout').addEventListener('click', () => {
                    netlifyIdentity.logout();
                });

                document.getElementById('netlifySignup').addEventListener('click', () => {
                    netlifyIdentity.open('signup');
                });
            }

            // Update Netlify Identity UI
            updateNetlifyUI() {
                const loginBtn = document.getElementById('netlifyLogin');
                const logoutBtn = document.getElementById('netlifyLogout');
                const signupBtn = document.getElementById('netlifySignup');
                const userInfo = document.getElementById('netlifyUserInfo');
                const userDetails = document.getElementById('userDetails');

                if (this.netlifyUser) {
                    // User is logged in
                    loginBtn.classList.add('hidden');
                    signupBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    userInfo.classList.remove('hidden');
                    
                    userDetails.innerHTML = `
                        <div class="space-y-2">
                            <div><strong>Nome:</strong> ${this.netlifyUser.user_metadata.full_name || 'Non specificato'}</div>
                            <div><strong>Email:</strong> ${this.netlifyUser.email}</div>
                            <div><strong>Ruolo:</strong> ${this.netlifyUser.app_metadata.roles ? this.netlifyUser.app_metadata.roles.join(', ') : 'Utente'}</div>
                            <div><strong>Ultimo accesso:</strong> ${new Date(this.netlifyUser.updated_at).toLocaleString('it-IT')}</div>
                        </div>
                    `;
                } else {
                    // User is not logged in
                    loginBtn.classList.remove('hidden');
                    signupBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    userInfo.classList.add('hidden');
                }
            }

            // Toggle admin panel
            toggleAdminPanel() {
                const panel = document.getElementById('adminPanel');
                panel.classList.toggle('hidden');
                
                if (!panel.classList.contains('hidden')) {
                    // Load current configuration
                    document.getElementById('serviceAccountEmail').value = this.config.serviceAccountEmail;
                    document.getElementById('serviceAccountKey').value = this.config.serviceAccountKey;
                    document.getElementById('sheetId').value = this.config.sheetId;
                    document.getElementById('openaiApiKey').value = this.config.openaiApiKey;
                    
                    // Load featured event data
                    this.loadFeaturedEventData();
                    
                    // Update backup info
                    this.updateBackupInfo();
                    
                    // Update session info
                    this.refreshSessionInfo();
                }
            }

            // Extend current session
            extendSession() {
                if (this.sessionManager) {
                    this.sessionManager.extendSession();
                    this.refreshSessionInfo();
                }
            }

            // Refresh session information display
            refreshSessionInfo() {
                if (!this.sessionManager) return;
                
                const sessionInfo = this.sessionManager.getSessionInfo();
                const currentSession = sessionInfo.current;
                
                if (currentSession.id) {
                    document.getElementById('sessionId').textContent = currentSession.id;
                    document.getElementById('sessionStart').textContent = new Date(currentSession.startTime).toLocaleString('it-IT');
                    document.getElementById('lastActivity').textContent = new Date(currentSession.lastActivity).toLocaleString('it-IT');
                    
                    const expiryTime = new Date(currentSession.lastActivity + this.sessionManager.sessionTimeout);
                    document.getElementById('sessionExpiry').textContent = expiryTime.toLocaleString('it-IT');
                    
                    // Update all sessions list
                    this.updateAllSessionsList(sessionInfo.all);
                } else {
                    document.getElementById('sessionId').textContent = 'Nessuna sessione attiva';
                    document.getElementById('sessionStart').textContent = '-';
                    document.getElementById('lastActivity').textContent = '-';
                    document.getElementById('sessionExpiry').textContent = '-';
                }
            }

            // Update all sessions list display
            updateAllSessionsList(sessions) {
                const container = document.getElementById('allSessionsList');
                
                if (sessions.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-600 italic">Nessuna sessione attiva</p>';
                    return;
                }
                
                container.innerHTML = sessions.map((session, index) => {
                    const isCurrentSession = session.id === this.sessionManager.sessionId;
                    const startTime = new Date(session.startTime).toLocaleString('it-IT');
                    const lastActivity = new Date(session.lastActivity).toLocaleString('it-IT');
                    const timeAgo = this.getTimeAgo(session.lastActivity);
                    
                    return `
                        <div class="flex items-center justify-between bg-white rounded-lg p-3 border ${isCurrentSession ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="font-mono text-xs ${isCurrentSession ? 'text-blue-700' : 'text-gray-600'}">${session.id}</span>
                                    ${isCurrentSession ? '<span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">CORRENTE</span>' : ''}
                                </div>
                                <div class="text-xs ${isCurrentSession ? 'text-blue-600' : 'text-gray-500'}">
                                    <div>Inizio: ${startTime}</div>
                                    <div>Ultima attività: ${timeAgo}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 ${this.getSessionStatusColor(session)} rounded-full"></div>
                                ${!isCurrentSession ? `<button onclick="app.terminateSession('${session.id}')" class="text-red-600 hover:text-red-800 text-xs font-medium">Termina</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Get time ago string
            getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                
                if (minutes < 1) return 'Ora';
                if (minutes < 60) return `${minutes} min fa`;
                if (hours < 24) return `${hours} ore fa`;
                return new Date(timestamp).toLocaleDateString('it-IT');
            }

            // Get session status color
            getSessionStatusColor(session) {
                const now = Date.now();
                const timeSinceActivity = now - session.lastActivity;
                const warningThreshold = 25 * 60 * 1000; // 25 minutes
                const expiredThreshold = 30 * 60 * 1000; // 30 minutes
                
                if (timeSinceActivity > expiredThreshold) return 'bg-red-400';
                if (timeSinceActivity > warningThreshold) return 'bg-yellow-400';
                return 'bg-green-400';
            }

            // Terminate specific session
            terminateSession(sessionId) {
                if (confirm('Sei sicuro di voler terminare questa sessione?')) {
                    let sessions = JSON.parse(localStorage.getItem('adminSessions') || '[]');
                    sessions = sessions.filter(session => session.id !== sessionId);
                    localStorage.setItem('adminSessions', JSON.stringify(sessions));
                    
                    this.refreshSessionInfo();
                    this.showNotification('Sessione terminata', 'success');
                }
            }

            // Logout all sessions
            logoutAllSessions() {
                if (confirm('⚠️ ATTENZIONE: Questo terminerà TUTTE le sessioni admin attive.\n\nSei sicuro di voler continuare?')) {
                    if (this.sessionManager) {
                        this.sessionManager.logoutAllSessions();
                    }
                    
                    // Close admin panel
                    document.getElementById('adminPanel').classList.add('hidden');
                    
                    // Show login modal after a delay
                    setTimeout(() => {
                        this.showAdminLogin();
                    }, 1500);
                }
            }

            // Toggle contact modal
            toggleContactModal() {
                const modal = document.getElementById('contactModal');
                modal.classList.toggle('hidden');
            }

            // Copy developer email
            async copyDeveloperEmail() {
                const email = 'aigallo2025@gmail.com';
                try {
                    await navigator.clipboard.writeText(email);
                    this.showNotification('Email copiata negli appunti!', 'success');
                } catch (error) {
                    console.error('Error copying email:', error);
                    this.fallbackCopy(email);
                }
            }

            // Load featured event data in admin panel
            loadFeaturedEventData() {
                // Load master featured event
                this.masterFeaturedEventId = localStorage.getItem('masterFeaturedEventId');
                
                // Load city featured events
                const cityFeaturedData = localStorage.getItem('cityFeaturedEvents');
                if (cityFeaturedData) {
                    this.cityFeaturedEvents = new Map(JSON.parse(cityFeaturedData));
                }
                
                this.updateMasterFeaturedDisplay();
                this.updateCityFeaturedDisplay();
                this.populateFeaturedSelects();
            }

            // Update master featured event display
            updateMasterFeaturedDisplay() {
                const select = document.getElementById('masterFeaturedEventSelect');
                const currentDisplay = document.getElementById('currentMasterFeatured');
                
                // Clear and populate select
                select.innerHTML = '<option value="">Seleziona evento master...</option>';
                this.events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.title} - ${this.formatDate(event.date)} (${event.city})`;
                    select.appendChild(option);
                });
                
                // Update current display
                if (this.masterFeaturedEventId) {
                    const featuredEvent = this.events.find(e => e.id == this.masterFeaturedEventId);
                    if (featuredEvent) {
                        currentDisplay.textContent = `${featuredEvent.title} - ${this.formatDate(featuredEvent.date)} (${featuredEvent.city})`;
                    } else {
                        currentDisplay.textContent = 'Evento non trovato (potrebbe essere stato eliminato)';
                    }
                } else {
                    currentDisplay.textContent = 'Nessun evento master';
                }
            }

            // Update city featured events display
            updateCityFeaturedDisplay() {
                const listContainer = document.getElementById('cityFeaturedList');
                
                if (this.cityFeaturedEvents.size === 0) {
                    listContainer.innerHTML = '<p class="text-sm text-yellow-600 italic">Nessun evento per città configurato</p>';
                    return;
                }
                
                listContainer.innerHTML = '';
                this.cityFeaturedEvents.forEach((eventId, city) => {
                    const event = this.events.find(e => e.id == eventId);
                    const eventDisplay = event ? 
                        `${event.title} - ${this.formatDate(event.date)}` : 
                        'Evento non trovato';
                    
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between bg-yellow-100 rounded-lg p-3';
                    item.innerHTML = `
                        <div>
                            <span class="font-medium text-yellow-800">${city}:</span>
                            <span class="text-yellow-700 ml-2">${eventDisplay}</span>
                        </div>
                        <button onclick="app.removeCityFeaturedEvent('${city}')" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                            Rimuovi
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            }

            // Populate featured event selects
            populateFeaturedSelects() {
                // Populate city select
                const citySelect = document.getElementById('cityFeaturedCitySelect');
                const cities = [...new Set(this.events.map(event => event.city).filter(city => city))].sort();
                
                citySelect.innerHTML = '<option value="">Seleziona città...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                
                this.updateCityFeaturedEventSelect();
            }

            // Update city featured event select based on selected city
            updateCityFeaturedEventSelect() {
                const citySelect = document.getElementById('cityFeaturedCitySelect');
                const eventSelect = document.getElementById('cityFeaturedEventSelect');
                const selectedCity = citySelect.value;
                
                eventSelect.innerHTML = '<option value="">Seleziona evento...</option>';
                
                if (selectedCity) {
                    const cityEvents = this.events.filter(event => event.city === selectedCity);
                    cityEvents.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.title} - ${this.formatDate(event.date)}`;
                        eventSelect.appendChild(option);
                    });
                }
            }

            // Set master featured event
            setMasterFeaturedEvent() {
                const select = document.getElementById('masterFeaturedEventSelect');
                const eventId = select.value;
                
                if (!eventId) {
                    this.showNotification('Seleziona un evento', 'error');
                    return;
                }
                
                this.masterFeaturedEventId = eventId;
                localStorage.setItem('masterFeaturedEventId', eventId);
                
                this.updateMasterFeaturedDisplay();
                this.renderEvents();
                this.showNotification('Evento master impostato!', 'success');
            }

            // Clear master featured event
            clearMasterFeaturedEvent() {
                this.masterFeaturedEventId = null;
                localStorage.removeItem('masterFeaturedEventId');
                
                this.updateMasterFeaturedDisplay();
                this.renderEvents();
                this.showNotification('Evento master rimosso', 'success');
            }

            // Set city featured event
            setCityFeaturedEvent() {
                const citySelect = document.getElementById('cityFeaturedCitySelect');
                const eventSelect = document.getElementById('cityFeaturedEventSelect');
                const city = citySelect.value;
                const eventId = eventSelect.value;
                
                if (!city || !eventId) {
                    this.showNotification('Seleziona città e evento', 'error');
                    return;
                }
                
                this.cityFeaturedEvents.set(city, eventId);
                localStorage.setItem('cityFeaturedEvents', JSON.stringify([...this.cityFeaturedEvents]));
                
                // Reset selects
                citySelect.value = '';
                eventSelect.value = '';
                
                this.updateCityFeaturedDisplay();
                this.renderEvents();
                this.showNotification(`Evento in primo piano impostato per ${city}!`, 'success');
            }

            // Remove city featured event
            removeCityFeaturedEvent(city) {
                this.cityFeaturedEvents.delete(city);
                localStorage.setItem('cityFeaturedEvents', JSON.stringify([...this.cityFeaturedEvents]));
                
                this.updateCityFeaturedDisplay();
                this.renderEvents();
                this.showNotification(`Evento rimosso per ${city}`, 'success');
            }

            // Check configuration status
            checkConfiguration() {
                const backupInfo = document.getElementById('backupDetails');
                
                // Check current configuration
                const currentConfig = {
                    serviceAccountEmail: !!this.config.serviceAccountEmail,
                    serviceAccountKey: !!this.config.serviceAccountKey,
                    sheetId: !!this.config.sheetId,
                    openaiApiKey: !!this.config.openaiApiKey
                };
                
                // Check backup
                const backupData = localStorage.getItem('configBackup');
                let backupStatus = 'Nessun backup trovato';
                
                if (backupData) {
                    try {
                        const backup = JSON.parse(backupData);
                        const backupDate = new Date(backup.timestamp).toLocaleString('it-IT');
                        backupStatus = `Ultimo backup: ${backupDate}`;
                    } catch (error) {
                        backupStatus = 'Backup corrotto';
                    }
                }
                
                // Check localStorage vs sessionStorage
                const localStorageConfig = {
                    email: !!localStorage.getItem('serviceAccountEmail'),
                    key: !!localStorage.getItem('serviceAccountKey'),
                    sheet: !!localStorage.getItem('sheetId'),
                    openai: !!localStorage.getItem('openaiApiKey')
                };
                
                const sessionStorageConfig = {
                    email: !!sessionStorage.getItem('serviceAccountEmail'),
                    key: !!sessionStorage.getItem('serviceAccountKey'),
                    sheet: !!sessionStorage.getItem('sheetId'),
                    openai: !!sessionStorage.getItem('openaiApiKey')
                };
                
                backupInfo.innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <strong>Configurazione Attuale:</strong>
                            <div class="ml-4 text-xs">
                                • Email: ${currentConfig.serviceAccountEmail ? '✅' : '❌'}<br>
                                • Chiave: ${currentConfig.serviceAccountKey ? '✅' : '❌'}<br>
                                • Sheet ID: ${currentConfig.sheetId ? '✅' : '❌'}<br>
                                • OpenAI: ${currentConfig.openaiApiKey ? '✅' : '❌'}
                            </div>
                        </div>
                        <div>
                            <strong>LocalStorage:</strong>
                            <div class="ml-4 text-xs">
                                • Email: ${localStorageConfig.email ? '✅' : '❌'}<br>
                                • Chiave: ${localStorageConfig.key ? '✅' : '❌'}<br>
                                • Sheet ID: ${localStorageConfig.sheet ? '✅' : '❌'}<br>
                                • OpenAI: ${localStorageConfig.openai ? '✅' : '❌'}
                            </div>
                        </div>
                        <div>
                            <strong>SessionStorage:</strong>
                            <div class="ml-4 text-xs">
                                • Email: ${sessionStorageConfig.email ? '✅' : '❌'}<br>
                                • Chiave: ${sessionStorageConfig.key ? '✅' : '❌'}<br>
                                • Sheet ID: ${sessionStorageConfig.sheet ? '✅' : '❌'}<br>
                                • OpenAI: ${sessionStorageConfig.openai ? '✅' : '❌'}
                            </div>
                        </div>
                        <div><strong>Backup:</strong> ${backupStatus}</div>
                    </div>
                `;
                
                this.showNotification('Verifica configurazione completata', 'success');
            }

            // Restore configuration from backup
            restoreConfiguration() {
                const backupData = localStorage.getItem('configBackup');
                
                if (!backupData) {
                    this.showNotification('Nessun backup trovato', 'error');
                    return;
                }
                
                try {
                    const backup = JSON.parse(backupData);
                    
                    // Try to restore from sessionStorage first
                    const sessionEmail = sessionStorage.getItem('serviceAccountEmail');
                    const sessionKey = sessionStorage.getItem('serviceAccountKey');
                    const sessionSheet = sessionStorage.getItem('sheetId');
                    const sessionOpenAI = sessionStorage.getItem('openaiApiKey');
                    
                    if (sessionEmail || sessionKey || sessionSheet || sessionOpenAI) {
                        // Restore from sessionStorage
                        if (sessionEmail) {
                            localStorage.setItem('serviceAccountEmail', sessionEmail);
                            this.config.serviceAccountEmail = sessionEmail;
                        }
                        if (sessionKey) {
                            localStorage.setItem('serviceAccountKey', sessionKey);
                            this.config.serviceAccountKey = sessionKey;
                        }
                        if (sessionSheet) {
                            localStorage.setItem('sheetId', sessionSheet);
                            this.config.sheetId = sessionSheet;
                        }
                        if (sessionOpenAI) {
                            localStorage.setItem('openaiApiKey', sessionOpenAI);
                            this.config.openaiApiKey = sessionOpenAI;
                        }
                        
                        // Update form fields
                        document.getElementById('serviceAccountEmail').value = this.config.serviceAccountEmail;
                        document.getElementById('serviceAccountKey').value = this.config.serviceAccountKey;
                        document.getElementById('sheetId').value = this.config.sheetId;
                        document.getElementById('openaiApiKey').value = this.config.openaiApiKey;
                        
                        this.updateConnectionStatus();
                        this.showNotification('Configurazione ripristinata da sessionStorage!', 'success');
                        
                        // Reload events to test connection
                        this.loadEvents();
                    } else {
                        this.showNotification('Nessuna configurazione valida trovata nei backup', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error restoring configuration:', error);
                    this.showNotification('Errore nel ripristino della configurazione', 'error');
                }
            }

            // Export configuration
            exportConfiguration() {
                const configExport = {
                    timestamp: new Date().toISOString(),
                    version: '2.0',
                    config: {
                        serviceAccountEmail: this.config.serviceAccountEmail,
                        sheetId: this.config.sheetId,
                        hasServiceAccountKey: !!this.config.serviceAccountKey,
                        hasOpenaiApiKey: !!this.config.openaiApiKey
                    },
                    note: 'Questo file contiene solo le informazioni non sensibili. Le chiavi API devono essere configurate manualmente.'
                };
                
                const blob = new Blob([JSON.stringify(configExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chi-facimu-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('Configurazione esportata!', 'success');
            }

            // Update backup info display
            updateBackupInfo() {
                const backupInfo = document.getElementById('backupDetails');
                
                // Check backup
                const backupData = localStorage.getItem('configBackup');
                let backupStatus = 'Nessun backup trovato';
                
                if (backupData) {
                    try {
                        const backup = JSON.parse(backupData);
                        const backupDate = new Date(backup.timestamp).toLocaleString('it-IT');
                        backupStatus = `✅ Ultimo backup: ${backupDate}`;
                    } catch (error) {
                        backupStatus = '❌ Backup corrotto';
                    }
                }
                
                // Check current config status
                const configStatus = this.config.serviceAccountEmail && this.config.serviceAccountKey && this.config.sheetId ? 
                    '✅ Configurazione completa' : '⚠️ Configurazione incompleta';
                
                backupInfo.innerHTML = `
                    <div class="space-y-2">
                        <div><strong>Stato:</strong> ${configStatus}</div>
                        <div><strong>Backup:</strong> ${backupStatus}</div>
                        <div><strong>Fonte:</strong> ${this.getConfigSource()}</div>
                    </div>
                `;
            }

            // Toggle mobile view
            toggleMobileView(view) {
                this.mobileView = view;
                
                const gridBtn = document.getElementById('gridViewBtn');
                const listBtn = document.getElementById('listViewBtn');
                const eventsGrid = document.getElementById('eventsGrid');
                const eventsList = document.getElementById('eventsList');
                
                if (view === 'grid') {
                    gridBtn.className = 'px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-white text-gray-900 shadow-sm';
                    listBtn.className = 'px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 text-gray-600';
                    eventsGrid.classList.remove('hidden');
                    eventsList.classList.add('hidden');
                } else {
                    listBtn.className = 'px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 bg-white text-gray-900 shadow-sm';
                    gridBtn.className = 'px-3 py-1 rounded-md text-sm font-medium transition-colors duration-200 text-gray-600';
                    eventsGrid.classList.add('hidden');
                    eventsList.classList.remove('hidden');
                }
                
                this.renderEvents();
            }

            // Handle JSON file upload
            async handleJsonUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const jsonData = JSON.parse(text);
                    
                    if (jsonData.type !== 'service_account') {
                        throw new Error('File JSON non valido. Assicurati di aver scaricato il file del Service Account.');
                    }
                    
                    // Auto-fill the form
                    document.getElementById('serviceAccountEmail').value = jsonData.client_email || '';
                    document.getElementById('serviceAccountKey').value = jsonData.private_key || '';
                    
                    this.showNotification('File JSON caricato con successo! Clicca "Salva Configurazione"', 'success');
                    
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    this.showNotification('Errore nel caricamento del file JSON. Verifica che sia valido.', 'error');
                }
                
                // Reset file input
                event.target.value = '';
            }

            // Save configuration
            saveConfiguration() {
                this.config.serviceAccountEmail = document.getElementById('serviceAccountEmail').value;
                this.config.serviceAccountKey = document.getElementById('serviceAccountKey').value;
                this.config.sheetId = document.getElementById('sheetId').value;
                this.config.openaiApiKey = document.getElementById('openaiApiKey').value;

                // Save to localStorage (primary backup)
                localStorage.setItem('serviceAccountEmail', this.config.serviceAccountEmail);
                localStorage.setItem('serviceAccountKey', this.config.serviceAccountKey);
                localStorage.setItem('sheetId', this.config.sheetId);
                localStorage.setItem('openaiApiKey', this.config.openaiApiKey);

                // Save to sessionStorage (secondary backup)
                sessionStorage.setItem('serviceAccountEmail', this.config.serviceAccountEmail);
                sessionStorage.setItem('serviceAccountKey', this.config.serviceAccountKey);
                sessionStorage.setItem('sheetId', this.config.sheetId);
                sessionStorage.setItem('openaiApiKey', this.config.openaiApiKey);

                // Create backup timestamp
                const backupData = {
                    timestamp: new Date().toISOString(),
                    config: {
                        serviceAccountEmail: this.config.serviceAccountEmail,
                        sheetId: this.config.sheetId,
                        hasKey: !!this.config.serviceAccountKey,
                        hasOpenAI: !!this.config.openaiApiKey
                    }
                };
                localStorage.setItem('configBackup', JSON.stringify(backupData));

                // Reset access token to force refresh
                this.accessToken = null;
                this.tokenExpiry = null;

                this.updateConnectionStatus();
                this.showNotification('Configurazione salvata e backup creato!', 'success');
                
                console.log('💾 Configurazione salvata:', {
                    email: !!this.config.serviceAccountEmail,
                    key: !!this.config.serviceAccountKey,
                    sheet: !!this.config.sheetId,
                    openai: !!this.config.openaiApiKey,
                    timestamp: new Date().toISOString()
                });
            }

            // Update connection status
            updateConnectionStatus() {
                const indicator = document.getElementById('connectionIndicator');
                const text = document.getElementById('connectionText');
                const subtext = document.getElementById('connectionSubtext');
                const sheetsStatus = document.getElementById('sheetsStatus');
                const sheetsStatusText = document.getElementById('sheetsStatusText');
                const ocrStatus = document.getElementById('ocrStatus');
                const ocrStatusText = document.getElementById('ocrStatusText');

                console.log('🔧 Controllo configurazione:', {
                    hasEmail: !!this.config.serviceAccountEmail,
                    hasKey: !!this.config.serviceAccountKey,
                    hasSheetId: !!this.config.sheetId,
                    hasOpenAI: !!this.config.openaiApiKey
                });

                if (this.config.serviceAccountEmail && this.config.serviceAccountKey && this.config.sheetId) {
                    const configSource = this.getConfigSource();
                    indicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    text.textContent = `Google Sheets - Connesso (${configSource})`;
                    subtext.textContent = 'Dati sincronizzati automaticamente con accesso completo';
                    sheetsStatus.className = 'w-3 h-3 bg-green-400 rounded-full';
                    sheetsStatusText.textContent = `Connesso (${configSource})`;
                    
                    console.log('✅ Configurazione Google Sheets valida');
                } else {
                    indicator.className = 'w-3 h-3 bg-orange-400 rounded-full animate-pulse';
                    text.textContent = 'Demo Mode - Dati di esempio';
                    subtext.textContent = 'Configura il Service Account nell\'admin panel o usa variabili d\'ambiente';
                    sheetsStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                    sheetsStatusText.textContent = 'Non configurato';
                    
                    console.log('⚠️ Configurazione Google Sheets mancante');
                }

                if (this.config.openaiApiKey) {
                    ocrStatus.className = 'w-3 h-3 bg-green-400 rounded-full';
                    ocrStatusText.textContent = 'Attivo';
                } else {
                    ocrStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                    ocrStatusText.textContent = 'Non configurato';
                }
            }

            // Get configuration source for display
            getConfigSource() {
                // Check if using environment variables
                if ((typeof process !== 'undefined' && process.env && process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL) ||
                    (typeof window !== 'undefined' && window.ENV && window.ENV.GOOGLE_SERVICE_ACCOUNT_EMAIL)) {
                    return 'Env Variables';
                }
                return 'Local Storage';
            }

            // Load events from Google Sheets or fallback to sample data
            async loadEvents() {
                this.showLoading(true);
                
                try {
                    if (this.config.serviceAccountEmail && this.config.serviceAccountKey && this.config.sheetId) {
                        console.log('🔄 Tentativo di connessione a Google Sheets...');
                        this.events = await this.fetchFromGoogleSheets();
                        this.updateSyncStatus('Sincronizzato con Google Sheets');
                        console.log(`✅ Caricati ${this.events.length} eventi da Google Sheets`);
                        
                        // If no events in sheet, show message instead of sample data
                        if (this.events.length === 0) {
                            this.updateSyncStatus('Google Sheets connesso - Nessun evento nel foglio');
                            console.log('ℹ️ Nessun evento trovato nel foglio Google');
                        }
                    } else {
                        console.log('⚠️ Configurazione Google Sheets mancante, usando dati di esempio');
                        this.events = this.getSampleEvents();
                        this.updateSyncStatus('Dati di esempio');
                    }
                } catch (error) {
                    console.error('❌ Errore nel caricamento da Google Sheets:', error);
                    
                    // Messaggio di errore più specifico
                    let errorMessage = 'Errore nel caricamento da Google Sheets';
                    if (error.message.includes('Unable to parse range')) {
                        errorMessage = 'Errore formato foglio Google Sheets. Verifica che il foglio si chiami "Sheet1"';
                    } else if (error.message.includes('access_denied')) {
                        errorMessage = 'Accesso negato. Verifica che il Service Account abbia accesso al foglio';
                    } else if (error.message.includes('not found')) {
                        errorMessage = 'Foglio Google Sheets non trovato. Verifica l\'ID del foglio';
                    }
                    
                    this.showNotification(errorMessage, 'error');
                    this.events = this.getSampleEvents();
                    this.updateSyncStatus('Errore - Usando dati di esempio');
                    console.log('🔄 Fallback ai dati di esempio');
                }
                
                this.showLoading(false);
                this.populateCityFilter();
                this.filterEvents();
            }

            // Get access token using Service Account
            async getAccessToken() {
                if (this.accessToken && this.tokenExpiry && Date.now() < this.tokenExpiry) {
                    return this.accessToken;
                }

                try {
                    const now = Math.floor(Date.now() / 1000);
                    const payload = {
                        iss: this.config.serviceAccountEmail,
                        scope: 'https://www.googleapis.com/auth/spreadsheets',
                        aud: 'https://oauth2.googleapis.com/token',
                        exp: now + 3600,
                        iat: now
                    };

                    const token = await this.createJWT(payload);
                    
                    const response = await fetch('https://oauth2.googleapis.com/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                            assertion: token
                        })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error_description || 'Failed to get access token');
                    }

                    this.accessToken = data.access_token;
                    this.tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000; // 1 minute buffer
                    
                    return this.accessToken;
                } catch (error) {
                    console.error('Error getting access token:', error);
                    throw error;
                }
            }

            // Create JWT token for Service Account authentication
            async createJWT(payload) {
                const header = {
                    alg: 'RS256',
                    typ: 'JWT'
                };

                const encodedHeader = this.base64UrlEncode(JSON.stringify(header));
                const encodedPayload = this.base64UrlEncode(JSON.stringify(payload));
                
                const signatureInput = `${encodedHeader}.${encodedPayload}`;
                
                // Import private key
                const privateKey = await crypto.subtle.importKey(
                    'pkcs8',
                    this.pemToArrayBuffer(this.config.serviceAccountKey),
                    {
                        name: 'RSASSA-PKCS1-v1_5',
                        hash: 'SHA-256'
                    },
                    false,
                    ['sign']
                );

                // Sign the token
                const signature = await crypto.subtle.sign(
                    'RSASSA-PKCS1-v1_5',
                    privateKey,
                    new TextEncoder().encode(signatureInput)
                );

                const encodedSignature = this.base64UrlEncode(signature);
                
                return `${signatureInput}.${encodedSignature}`;
            }

            // Convert PEM to ArrayBuffer
            pemToArrayBuffer(pem) {
                const b64 = pem
                    .replace(/-----BEGIN PRIVATE KEY-----/g, '')
                    .replace(/-----END PRIVATE KEY-----/g, '')
                    .replace(/\s/g, '');
                
                const binaryString = atob(b64);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                return bytes.buffer;
            }

            // Base64 URL encode
            base64UrlEncode(data) {
                let base64;
                if (typeof data === 'string') {
                    base64 = btoa(data);
                } else {
                    base64 = btoa(String.fromCharCode(...new Uint8Array(data)));
                }
                
                return base64
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }

            // Fetch events from Google Sheets
            async fetchFromGoogleSheets() {
    try {
        // Chiama la Netlify Function invece di usare le API keys
        const response = await fetch('/.netlify/functions/get-events');
        
        if (!response.ok) {
            throw new Error('Failed to fetch events');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Unknown error');
        }
        
        console.log(`✅ Caricati ${data.count} eventi dal database sicuro`);
        return data.events;
        
    } catch (error) {
        console.error('❌ Errore nel caricamento eventi:', error);
        throw error;
    }
}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || 'Failed to fetch from Google Sheets');
                }
                
                const data = await response.json();
                
                const events = data.values?.map((row, index) => {
                    const event = {
                        id: index + 1,
                        title: row[0] || '',
                        date: row[1] || '',
                        time: row[2] || '',
                        location: row[3] || '',
                        city: row[4] || '',
                        coordinates: row[5] && row[6] ? { lat: parseFloat(row[5]), lng: parseFloat(row[6]) } : null,
                        category: row[7] || '',
                        description: row[8] || '',
                        organizer: row[9] || '',
                        price: row[10] || '',
                        image: row[11] || '📅'
                    };
                    
                    // Debug: log date format from sheet
                    if (event.date) {
                        console.log(`📅 Evento "${event.title}" - Data dal foglio: "${event.date}" (tipo: ${typeof event.date})`);
                    }
                    
                    return event;
                }) || [];
                
                return events;
            }

            // Process uploaded image for event extraction
            async processImage(file) {
                if (!this.config.openaiApiKey) {
                    this.showNotification('Configura OpenAI API Key per l\'estrazione automatica', 'error');
                    return;
                }

                this.showUploadProgress(true);
                this.updateProgress(20, 'Caricamento immagine...');

                try {
                    const base64 = await this.fileToBase64(file);
                    this.updateProgress(50, 'Analisi immagine...');
                    
                    const extractedEvents = await this.extractEventsFromImage(base64);
                    this.updateProgress(100, 'Completato!');
                    
                    setTimeout(() => {
                        this.showUploadProgress(false);
                        this.displayExtractedEvents(extractedEvents);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error processing image:', error);
                    this.showNotification('Errore nell\'elaborazione dell\'immagine', 'error');
                    this.showUploadProgress(false);
                }
            }

            // Convert file to base64
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Extract events from image using OpenAI Vision API
            async extractEventsFromImage(base64Image) {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.config.openaiApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4-vision-preview",
                        messages: [{
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "Estrai tutti gli eventi da questa immagine di un programma. Per ogni evento, fornisci: titolo, data (YYYY-MM-DD), ora (HH:MM), luogo, città, categoria (Musica/Arte/Sport/Cultura/Food), descrizione, organizzatore, prezzo. Rispondi solo con un JSON array valido."
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64Image}`
                                    }
                                }
                            ]
                        }],
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // Fallback parsing if JSON is malformed
                    return this.parseEventsFromText(content);
                }
            }

            // Fallback text parsing
            parseEventsFromText(text) {
                // Simple text parsing logic as fallback
                return [{
                    title: "Evento estratto da immagine",
                    date: new Date().toISOString().split('T')[0],
                    time: "20:00",
                    location: "Da definire",
                    city: "Palermo",
                    category: "Cultura",
                    description: "Evento estratto automaticamente dall'immagine",
                    organizer: "Da definire",
                    price: "Da definire"
                }];
            }

            // Display extracted events for review
            displayExtractedEvents(events) {
                const container = document.getElementById('eventsPreview');
                const extractedSection = document.getElementById('extractedEvents');
                
                container.innerHTML = events.map((event, index) => `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Titolo:</strong> ${event.title}</div>
                            <div><strong>Data:</strong> ${event.date}</div>
                            <div><strong>Ora:</strong> ${event.time}</div>
                            <div><strong>Luogo:</strong> ${event.location}</div>
                            <div><strong>Città:</strong> ${event.city}</div>
                            <div><strong>Categoria:</strong> ${event.category}</div>
                            <div class="col-span-2"><strong>Descrizione:</strong> ${event.description}</div>
                        </div>
                    </div>
                `).join('');
                
                extractedSection.classList.remove('hidden');
                this.extractedEventsData = events;
            }

            // Approve and upload extracted events
            async approveExtractedEvents() {
                if (!this.extractedEventsData) return;
                
                try {
                    for (const event of this.extractedEventsData) {
                        await this.addEventToSheet(event);
                    }
                    
                    this.showNotification('Eventi caricati con successo!', 'success');
                    document.getElementById('extractedEvents').classList.add('hidden');
                    this.loadEvents(); // Refresh events
                    
                } catch (error) {
                    console.error('Error uploading events:', error);
                    this.showNotification('Errore nel caricamento degli eventi', 'error');
                }
            }

            // Add manual event
            async addManualEvent() {
                const event = {
                    title: document.getElementById('manualTitle').value,
                    date: document.getElementById('manualDate').value,
                    time: document.getElementById('manualTime').value,
                    location: document.getElementById('manualLocation').value,
                    city: document.getElementById('manualCity').value,
                    category: document.getElementById('manualCategory').value,
                    description: document.getElementById('manualDescription').value,
                    organizer: document.getElementById('manualOrganizer').value,
                    price: document.getElementById('manualPrice').value
                };

                if (!event.title || !event.date || !event.location) {
                    this.showNotification('Compila almeno titolo, data e luogo', 'error');
                    return;
                }

                try {
                    await this.addEventToSheet(event);
                    this.showNotification('Evento aggiunto con successo!', 'success');
                    this.clearManualForm();
                    this.loadEvents();
                } catch (error) {
                    console.error('Error adding manual event:', error);
                    this.showNotification('Errore nell\'aggiunta dell\'evento', 'error');
                }
            }

            // Add event to Google Sheet
            async addEventToSheet(event) {
                if (!this.config.serviceAccountEmail || !this.config.serviceAccountKey || !this.config.sheetId) {
                    throw new Error('Service Account not configured');
                }

                const coordinates = await this.geocodeAddress(`${event.location}, ${event.city}`);
                
                const values = [[
                    event.title,
                    event.date,
                    event.time,
                    event.location,
                    event.city,
                    coordinates?.lat || '',
                    coordinates?.lng || '',
                    event.category,
                    event.description,
                    event.organizer,
                    event.price,
                    this.getCategoryEmoji(event.category)
                ]];

                const accessToken = await this.getAccessToken();
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.config.sheetId}/values/Sheet1!A:L:append?valueInputOption=RAW`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ values })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || 'Failed to add event to sheet');
                }
            }

            // Geocode address to coordinates
            async geocodeAddress(address) {
                try {
                    // This would use a geocoding service like Google Maps API
                    // For demo purposes, return approximate coordinates for Sicilian cities
                    const cityCoords = {
                        'Palermo': { lat: 38.1157, lng: 13.3613 },
                        'Catania': { lat: 37.5079, lng: 15.0830 },
                        'Messina': { lat: 38.1938, lng: 15.5540 },
                        'Siracusa': { lat: 37.0755, lng: 15.2866 },
                        'Trapani': { lat: 38.0176, lng: 12.5365 },
                        'Agrigento': { lat: 37.3257, lng: 13.5756 },
                        'Ragusa': { lat: 36.9280, lng: 14.7273 },
                        'Caltanissetta': { lat: 37.4863, lng: 14.0625 },
                        'Enna': { lat: 37.5630, lng: 14.2789 }
                    };
                    
                    for (const [city, coords] of Object.entries(cityCoords)) {
                        if (address.toLowerCase().includes(city.toLowerCase())) {
                            return coords;
                        }
                    }
                    
                    return cityCoords['Palermo']; // Default to Palermo
                } catch (error) {
                    console.error('Geocoding error:', error);
                    return null;
                }
            }

            // Get category emoji
            getCategoryEmoji(category) {
                const emojis = {
                    'Musica': '🎵',
                    'Arte': '🎨',
                    'Sport': '⚽',
                    'Cultura': '📚',
                    'Food': '🍽️'
                };
                return emojis[category] || '📅';
            }

            // Clear manual form
            clearManualForm() {
                document.getElementById('manualTitle').value = '';
                document.getElementById('manualDate').value = '';
                document.getElementById('manualTime').value = '';
                document.getElementById('manualLocation').value = '';
                document.getElementById('manualCity').value = '';
                document.getElementById('manualCategory').value = '';
                document.getElementById('manualDescription').value = '';
                document.getElementById('manualOrganizer').value = '';
                document.getElementById('manualPrice').value = '';
            }

            // Show upload progress
            showUploadProgress(show) {
                const progress = document.getElementById('uploadProgress');
                if (show) {
                    progress.classList.remove('hidden');
                } else {
                    progress.classList.add('hidden');
                    this.updateProgress(0, '');
                }
            }

            // Update progress bar
            updateProgress(percent, text) {
                document.getElementById('progressBar').style.width = `${percent}%`;
                document.getElementById('progressText').textContent = text;
            }

            // Show loading skeleton
            showLoading(show) {
                const skeleton = document.getElementById('loadingSkeleton');
                const grid = document.getElementById('eventsGrid');
                
                if (show) {
                    skeleton.classList.remove('hidden');
                    grid.classList.add('hidden');
                } else {
                    skeleton.classList.add('hidden');
                    grid.classList.remove('hidden');
                }
            }

            // Update sync status
            updateSyncStatus(status) {
                const syncStatus = document.getElementById('syncStatus');
                const indicator = syncStatus.querySelector('div');
                const text = syncStatus.querySelector('span');
                
                text.textContent = status;
                this.lastSync = new Date();
                
                if (status.includes('Errore')) {
                    indicator.className = 'w-2 h-2 bg-red-400 rounded-full';
                } else if (status.includes('esempio')) {
                    indicator.className = 'w-2 h-2 bg-orange-400 rounded-full animate-pulse';
                } else {
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
                }
            }

            // Start auto-sync
            startAutoSync() {
                if (this.autoSyncInterval) clearInterval(this.autoSyncInterval);
                
                this.autoSyncInterval = setInterval(() => {
                    if (this.config.serviceAccountEmail && this.config.serviceAccountKey && this.config.sheetId) {
                        this.loadEvents();
                    }
                }, 5 * 60 * 1000); // Every 5 minutes
            }

            // Parse event date with multiple format support
            parseEventDate(dateString) {
                if (!dateString) return null;
                
                try {
                    // Handle different date formats
                    if (dateString.includes('/')) {
                        const parts = dateString.split('/');
                        if (parts.length === 3) {
                            let day, month, year;
                            
                            const first = parseInt(parts[0]);
                            const second = parseInt(parts[1]);
                            const third = parseInt(parts[2]);
                            
                            // If third part is 4 digits, it's likely the year
                            if (third > 31) {
                                year = third;
                                // European format DD/MM/YYYY
                                if (first <= 31 && second <= 12) {
                                    day = first;
                                    month = second - 1;
                                }
                                // American format MM/DD/YYYY
                                else if (second <= 31 && first <= 12) {
                                    day = second;
                                    month = first - 1;
                                }
                            }
                            // If first part is 4 digits, it might be YYYY/MM/DD
                            else if (first > 31) {
                                year = first;
                                month = second - 1;
                                day = third;
                            }
                            
                            if (year && month !== undefined && day) {
                                return new Date(year, month, day);
                            }
                        }
                    } else if (dateString.includes('-')) {
                        const parts = dateString.split('-');
                        if (parts.length === 3) {
                            const first = parseInt(parts[0]);
                            const second = parseInt(parts[1]);
                            const third = parseInt(parts[2]);
                            
                            // YYYY-MM-DD format
                            if (first > 31) {
                                return new Date(first, second - 1, third);
                            }
                            // DD-MM-YYYY format
                            else if (third > 31) {
                                return new Date(third, second - 1, first);
                            }
                        }
                        
                        // Fallback: try ISO format
                        const isoDate = new Date(dateString + 'T00:00:00');
                        if (!isNaN(isoDate.getTime())) {
                            return isoDate;
                        }
                    }
                    
                    // Try to parse as-is
                    const directDate = new Date(dateString);
                    if (!isNaN(directDate.getTime())) {
                        return directDate;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('❌ Errore nel parsing della data:', dateString, error);
                    return null;
                }
            }

            // Calculate distance between coordinates
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            // Check if event is not in the past
            isEventNotPast(event) {
                if (!event.date) return true; // If no date, show the event
                
                try {
                    const eventDate = this.parseEventDate(event.date);
                    if (!eventDate || isNaN(eventDate.getTime())) {
                        console.warn('⚠️ Data evento non valida, mostro comunque:', event.date);
                        return true; // If date is invalid, show the event
                    }
                    
                    // Get today's date at midnight
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Set event date to midnight for comparison
                    const eventDateMidnight = new Date(eventDate);
                    eventDateMidnight.setHours(0, 0, 0, 0);
                    
                    // Event is not past if it's today or in the future
                    const isNotPast = eventDateMidnight >= today;
                    
                    if (!isNotPast) {
                        console.log(`🗓️ Evento passato nascosto: "${event.title}" - ${event.date}`);
                    }
                    
                    return isNotPast;
                } catch (error) {
                    console.error('❌ Errore nel controllo data passata:', event.date, error);
                    return true; // If error, show the event
                }
            }

            // Get user's geolocation
            getUserLocation() {
                if (!navigator.geolocation) {
                    this.showNotification('Geolocalizzazione non supportata', 'error');
                    return;
                }

                const btn = document.getElementById('geoLocationBtn');
                const text = document.getElementById('geoLocationText');
                const status = document.getElementById('geoStatus');

                text.textContent = 'Rilevamento...';
                btn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        text.textContent = 'Posizione rilevata';
                        status.classList.remove('hidden');
                        btn.disabled = false;
                        this.filterEvents();
                    },
                    (error) => {
                        let errorMessage = 'Errore nel rilevamento della posizione';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Permesso negato per la geolocalizzazione';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Posizione non disponibile';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Timeout nel rilevamento della posizione';
                                break;
                        }
                        this.showNotification(errorMessage, 'error');
                        text.textContent = 'Usa la mia posizione';
                        btn.disabled = false;
                    }
                );
            }

            // Clear all filters
            clearAllFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('dateFilter').value = '';
                document.getElementById('cityFilter').value = '';
                document.getElementById('radiusFilter').value = '';
                this.userLocation = null;
                document.getElementById('geoLocationText').textContent = 'Usa la mia posizione';
                document.getElementById('geoStatus').classList.add('hidden');
                this.filterEvents();
            }

            // Refresh events
            refreshEvents() {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('animate-spin');
                
                setTimeout(() => {
                    btn.classList.remove('animate-spin');
                    this.loadEvents();
                }, 1000);
            }

            // Populate city filter with actual cities from events
            populateCityFilter() {
                const cityFilter = document.getElementById('cityFilter');
                const cities = [...new Set(this.events.map(event => event.city).filter(city => city))].sort();
                
                // Keep the "All cities" option and add actual cities
                cityFilter.innerHTML = '<option value="">🏙️ Tutte le città</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    cityFilter.appendChild(option);
                });
            }

            // Filter events based on current filters
            filterEvents() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const selectedCategory = document.getElementById('categoryFilter').value;
                const selectedDate = document.getElementById('dateFilter').value;
                const selectedCity = document.getElementById('cityFilter').value;
                const selectedRadius = document.getElementById('radiusFilter').value;

                this.filteredEvents = this.events.filter(event => {
                    // First check: exclude past events
                    const isNotPastEvent = this.isEventNotPast(event);
                    if (!isNotPastEvent) return false;

                    const matchesSearch = event.title.toLowerCase().includes(searchTerm) || 
                                        event.description.toLowerCase().includes(searchTerm) ||
                                        event.location.toLowerCase().includes(searchTerm);
                    
                    const matchesCategory = !selectedCategory || event.category === selectedCategory;
                    const matchesCity = !selectedCity || event.city === selectedCity;
                    
                    let matchesDate = true;
                    if (selectedDate && event.date) {
                        try {
                            let eventDate = this.parseEventDate(event.date);
                            
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            
                            if (eventDate && !isNaN(eventDate.getTime())) {
                                const tomorrow = new Date(today);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                
                                switch(selectedDate) {
                                    case 'today':
                                        matchesDate = eventDate.toDateString() === today.toDateString();
                                        break;
                                    case 'tomorrow':
                                        matchesDate = eventDate.toDateString() === tomorrow.toDateString();
                                        break;
                                    case 'week':
                                        const weekFromNow = new Date(today);
                                        weekFromNow.setDate(weekFromNow.getDate() + 7);
                                        matchesDate = eventDate >= today && eventDate <= weekFromNow;
                                        break;
                                    case 'month':
                                        const monthFromNow = new Date(today);
                                        monthFromNow.setMonth(monthFromNow.getMonth() + 1);
                                        matchesDate = eventDate >= today && eventDate <= monthFromNow;
                                        break;
                                }
                            } else {
                                console.warn('⚠️ Data evento non valida per filtro:', event.date);
                                matchesDate = false;
                            }
                        } catch (error) {
                            console.error('❌ Errore nel parsing data per filtro:', event.date, error);
                            matchesDate = false;
                        }
                    }
                    
                    let matchesRadius = true;
                    if (selectedRadius && this.userLocation && event.coordinates) {
                        const distance = this.calculateDistance(
                            this.userLocation.lat, this.userLocation.lng,
                            event.coordinates.lat, event.coordinates.lng
                        );
                        matchesRadius = distance <= parseInt(selectedRadius);
                    }
                    
                    return matchesSearch && matchesCategory && matchesDate && matchesCity && matchesRadius;
                });

                // Sort by distance if user location is available
                if (this.userLocation) {
                    this.filteredEvents.sort((a, b) => {
                        if (!a.coordinates || !b.coordinates) return 0;
                        const distanceA = this.calculateDistance(
                            this.userLocation.lat, this.userLocation.lng,
                            a.coordinates.lat, a.coordinates.lng
                        );
                        const distanceB = this.calculateDistance(
                            this.userLocation.lat, this.userLocation.lng,
                            b.coordinates.lat, b.coordinates.lng
                        );
                        return distanceA - distanceB;
                    });
                }

                this.renderEvents();
            }

            // Format date for display
            formatDate(dateString) {
                if (!dateString) return 'Data non disponibile';
                
                try {
                    const date = this.parseEventDate(dateString);
                    
                    // Final validation
                    if (!date || isNaN(date.getTime())) {
                        console.warn('⚠️ Data non valida:', dateString);
                        return `📅 ${dateString}`;
                    }
                    
                    // Additional check for reasonable date range
                    const currentYear = new Date().getFullYear();
                    if (date.getFullYear() < 1900 || date.getFullYear() > currentYear + 10) {
                        console.warn('⚠️ Data fuori range:', dateString);
                        return `📅 ${dateString}`;
                    }
                    
                    return date.toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } catch (error) {
                    console.error('❌ Errore nel parsing della data:', dateString, error);
                    return `📅 ${dateString}`;
                }
            }

            // Create featured event card HTML
            createFeaturedEventCard(event) {
                let distanceInfo = '';
                if (this.userLocation && event.coordinates) {
                    const distance = this.calculateDistance(
                        this.userLocation.lat, this.userLocation.lng,
                        event.coordinates.lat, event.coordinates.lng
                    );
                    distanceInfo = `
                        <div class="flex items-center space-x-2 mt-2">
                            <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span class="text-sm text-green-600 font-medium">${distance.toFixed(1)} km da te</span>
                        </div>
                    `;
                }

                return `
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="app.openEventModal(${event.id})">
                        <div class="p-6 text-white">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="text-5xl">${event.image}</div>
                                    <div class="bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full flex items-center space-x-1">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        <span>IN PRIMO PIANO</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="bg-white bg-opacity-20 text-white text-xs font-semibold px-3 py-1 rounded-full mb-1">${event.category}</div>
                                    <div class="text-xs text-white text-opacity-90 font-medium">${event.city}</div>
                                </div>
                            </div>
                            <h2 class="text-2xl font-bold mb-3">${event.title}</h2>
                            <div class="space-y-3 text-white text-opacity-90">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                    </svg>
                                    <span class="font-medium">${this.formatDate(event.date)} - ${event.time}</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <span class="font-medium">${event.location}</span>
                                </div>
                                ${distanceInfo}
                                <div class="flex items-center justify-between mt-4 pt-4 border-t border-white border-opacity-20">
                                    <span class="font-bold text-yellow-300 text-xl">${event.price}</span>
                                    <span class="text-sm text-white text-opacity-75">by ${event.organizer}</span>
                                </div>
                            </div>
                            <p class="text-white text-opacity-80 text-sm mt-3 line-clamp-2">${event.description}</p>
                        </div>
                    </div>
                `;
            }

            // Create event card HTML
            createEventCard(event) {
                let distanceInfo = '';
                if (this.userLocation && event.coordinates) {
                    const distance = this.calculateDistance(
                        this.userLocation.lat, this.userLocation.lng,
                        event.coordinates.lat, event.coordinates.lng
                    );
                    distanceInfo = `
                        <div class="flex items-center space-x-2 mt-1">
                            <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span class="text-xs text-green-600 font-medium">${distance.toFixed(1)} km da te</span>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white rounded-xl shadow-sm card-hover cursor-pointer" onclick="app.openEventModal(${event.id})">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="text-4xl">${event.image}</div>
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="bg-purple-100 text-purple-custom text-xs font-semibold px-3 py-1 rounded-full">${event.category}</span>
                                    <span class="text-xs text-gray-500 font-medium">${event.city}</span>
                                </div>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${event.title}</h3>
                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-purple-custom" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                    </svg>
                                    <span class="text-sm font-medium">${this.formatDate(event.date)} - ${event.time}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 gradient-location rounded-full p-1" fill="white" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <span class="text-sm font-medium">${event.location}</span>
                                </div>
                                ${distanceInfo}
                                <div class="flex items-center justify-between mt-4">
                                    <span class="font-semibold text-purple-custom text-lg">${event.price}</span>
                                    <span class="text-xs text-gray-500 font-medium">by ${event.organizer}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Create event list item HTML (mobile compact view)
            createEventListItem(event) {
                let distanceInfo = '';
                if (this.userLocation && event.coordinates) {
                    const distance = this.calculateDistance(
                        this.userLocation.lat, this.userLocation.lng,
                        event.coordinates.lat, event.coordinates.lng
                    );
                    distanceInfo = `<span class="text-xs text-green-600 font-medium">${distance.toFixed(1)} km</span>`;
                }

                return `
                    <div class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="app.openEventModal(${event.id})">
                        <div class="flex items-start space-x-4">
                            <div class="text-3xl flex-shrink-0">${event.image}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between mb-2">
                                    <h3 class="text-base font-semibold text-gray-900 truncate pr-2">${event.title}</h3>
                                    <div class="flex flex-col items-end space-y-1 flex-shrink-0">
                                        <span class="bg-purple-100 text-purple-custom text-xs font-medium px-2 py-1 rounded-full">${event.category}</span>
                                        ${distanceInfo}
                                    </div>
                                </div>
                                <div class="space-y-1 text-sm text-gray-600">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-purple-custom flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                        <span class="truncate">${this.formatDate(event.date)} - ${event.time}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-purple-custom flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                        <span class="truncate">${event.location}, ${event.city}</span>
                                    </div>
                                    <div class="flex items-center justify-between mt-2">
                                        <span class="font-semibold text-purple-custom">${event.price}</span>
                                        <span class="text-xs text-gray-500 truncate">by ${event.organizer}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render events
            renderEvents() {
                const grid = document.getElementById('eventsGrid');
                const list = document.getElementById('eventsList');
                const noEvents = document.getElementById('noEvents');
                const featuredSection = document.getElementById('featuredEvent');

                // Determine which featured event to show
                let featuredEvent = null;
                let otherEvents = [...this.filteredEvents];
                
                // Get current city filter
                const selectedCity = document.getElementById('cityFilter').value;
                
                if (selectedCity && this.cityFeaturedEvents.has(selectedCity)) {
                    // Show city-specific featured event
                    const cityFeaturedId = this.cityFeaturedEvents.get(selectedCity);
                    featuredEvent = this.filteredEvents.find(e => e.id == cityFeaturedId);
                } else if (!selectedCity && this.masterFeaturedEventId) {
                    // Show master featured event when no city is selected
                    featuredEvent = this.filteredEvents.find(e => e.id == this.masterFeaturedEventId);
                }
                
                // Remove featured event from other events list
                if (featuredEvent) {
                    otherEvents = this.filteredEvents.filter(e => e.id != featuredEvent.id);
                    featuredSection.innerHTML = this.createFeaturedEventCard(featuredEvent);
                    featuredSection.classList.remove('hidden');
                } else {
                    featuredSection.classList.add('hidden');
                }

                // Handle no events case
                if (this.filteredEvents.length === 0) {
                    grid.classList.add('hidden');
                    list.classList.add('hidden');
                    noEvents.classList.remove('hidden');
                    return;
                } else {
                    noEvents.classList.add('hidden');
                }

                // Render based on mobile view preference
                if (this.mobileView === 'list') {
                    grid.classList.add('hidden');
                    list.classList.remove('hidden');
                    list.innerHTML = otherEvents.map(event => this.createEventListItem(event)).join('');
                } else {
                    list.classList.add('hidden');
                    grid.classList.remove('hidden');
                    grid.innerHTML = otherEvents.map(event => this.createEventCard(event)).join('');
                }
            }

            // Open event modal
            openEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const modal = document.getElementById('eventModal');
                const content = document.getElementById('modalContent');

                content.innerHTML = `
                    <div class="relative">
                        <button onclick="app.closeEventModal()" class="absolute top-4 right-4 text-gray-400 hover:text-purple-custom z-10 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">${event.image}</div>
                                <h2 class="text-2xl font-bold text-gray-900 mb-2">${event.title}</h2>
                                <span class="bg-purple-100 text-purple-custom text-sm font-semibold px-4 py-2 rounded-full">${event.category}</span>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <div class="flex items-center space-x-3 text-gray-700">
                                    <svg class="w-6 h-6 text-purple-custom" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                    </svg>
                                    <span class="font-medium">${this.formatDate(event.date)} alle ${event.time}</span>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-700">
                                    <div class="w-6 h-6 gradient-location rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="white" viewBox="0 0 24 24">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                    </div>
                                    <span class="font-medium">${event.location}</span>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-700">
                                    <svg class="w-6 h-6 text-purple-custom" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    <span class="font-medium">Organizzato da ${event.organizer}</span>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-700">
                                    <svg class="w-6 h-6 text-purple-custom" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                    </svg>
                                    <span class="font-bold text-purple-custom text-lg">${event.price}</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h3 class="font-semibold text-gray-900 mb-2">Descrizione</h3>
                                <p class="text-gray-600">${event.description}</p>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex space-x-3">
                                    <button onclick="app.addToCalendar(${event.id})" class="flex-1 bg-purple-custom hover-purple-custom text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                        <span>Salva in Calendario</span>
                                    </button>
                                    <button onclick="app.shareEvent(${event.id})" class="flex-1 gradient-location text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 hover:opacity-90 flex items-center justify-center space-x-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                        </svg>
                                        <span>Condividi</span>
                                    </button>
                                </div>
                                
                                <!-- Quick Share Options -->
                                <div class="flex space-x-2">
                                    <button onclick="app.shareOnWhatsApp(${event.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 text-sm">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                        </svg>
                                        <span>WhatsApp</span>
                                    </button>
                                    <button onclick="app.openMaps(${event.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 text-sm">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                        <span>Indicazioni</span>
                                    </button>
                                    <button onclick="app.copyEventLink(${event.id})" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 text-sm">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                        </svg>
                                        <span>Copia Link</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }

            // Close event modal
            closeEventModal() {
                document.getElementById('eventModal').classList.add('hidden');
            }

            // Add event to calendar
            addToCalendar(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                try {
                    const eventDate = this.parseEventDate(event.date);
                    if (!eventDate) {
                        this.showNotification('Data evento non valida', 'error');
                        return;
                    }

                    // Parse time
                    const [hours, minutes] = event.time.split(':').map(Number);
                    const startDate = new Date(eventDate);
                    startDate.setHours(hours, minutes, 0, 0);
                    
                    // End date (assume 2 hours duration)
                    const endDate = new Date(startDate);
                    endDate.setHours(startDate.getHours() + 2);

                    // Format dates for calendar
                    const formatDate = (date) => {
                        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    };

                    // Create calendar event URL (Google Calendar)
                    const calendarUrl = new URL('https://calendar.google.com/calendar/render');
                    calendarUrl.searchParams.set('action', 'TEMPLATE');
                    calendarUrl.searchParams.set('text', event.title);
                    calendarUrl.searchParams.set('dates', `${formatDate(startDate)}/${formatDate(endDate)}`);
                    calendarUrl.searchParams.set('details', `${event.description}\n\nOrganizzatore: ${event.organizer}\nPrezzo: ${event.price}`);
                    calendarUrl.searchParams.set('location', `${event.location}, ${event.city}`);

                    // Open calendar
                    window.open(calendarUrl.toString(), '_blank');
                    this.showNotification('Evento aggiunto al calendario!', 'success');

                } catch (error) {
                    console.error('Error adding to calendar:', error);
                    this.showNotification('Errore nell\'aggiunta al calendario', 'error');
                }
            }

            // Share event (generic)
            shareEvent(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const shareText = this.createShareText(event);

                if (navigator.share) {
                    navigator.share({
                        title: event.title,
                        text: shareText,
                        url: window.location.href
                    }).then(() => {
                        this.showNotification('Evento condiviso!', 'success');
                    }).catch((error) => {
                        console.log('Error sharing:', error);
                        this.fallbackShare(shareText);
                    });
                } else {
                    this.fallbackShare(shareText);
                }
            }

            // Share on WhatsApp
            shareOnWhatsApp(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const shareText = this.createShareText(event);
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                
                window.open(whatsappUrl, '_blank');
                this.showNotification('Condiviso su WhatsApp!', 'success');
            }

            // Open Maps for directions
            openMaps(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const destination = encodeURIComponent(`${event.location}, ${event.city}`);
                
                // Detect device and open appropriate maps app
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                
                if (/android/i.test(userAgent)) {
                    // Android - try Google Maps app first, fallback to web
                    const androidUrl = `geo:0,0?q=${destination}`;
                    const fallbackUrl = `https://maps.google.com/maps?q=${destination}`;
                    
                    // Try to open native app
                    window.location.href = androidUrl;
                    
                    // Fallback to web after a short delay
                    setTimeout(() => {
                        window.open(fallbackUrl, '_blank');
                    }, 1000);
                    
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    // iOS - try Apple Maps first, fallback to Google Maps web
                    const iosUrl = `maps://maps.apple.com/?q=${destination}`;
                    const fallbackUrl = `https://maps.google.com/maps?q=${destination}`;
                    
                    // Try to open Apple Maps
                    window.location.href = iosUrl;
                    
                    // Fallback to Google Maps web after a short delay
                    setTimeout(() => {
                        window.open(fallbackUrl, '_blank');
                    }, 1000);
                    
                } else {
                    // Desktop or other - open Google Maps web
                    const webUrl = `https://maps.google.com/maps?q=${destination}`;
                    window.open(webUrl, '_blank');
                }
                
                this.showNotification('Apertura mappe per le indicazioni...', 'success');
            }

            // Copy event link
            async copyEventLink(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                const shareText = this.createShareText(event);
                const fullText = `${shareText}\n\n🔗 ${window.location.href}`;

                try {
                    await navigator.clipboard.writeText(fullText);
                    this.showNotification('Link copiato negli appunti!', 'success');
                } catch (error) {
                    console.error('Error copying to clipboard:', error);
                    this.fallbackCopy(fullText);
                }
            }

            // Create share text
            createShareText(event) {
                const formattedDate = this.formatDate(event.date);
                return `🎉 ${event.title}

📅 ${formattedDate} alle ${event.time}
📍 ${event.location}, ${event.city}
🎯 ${event.category}
💰 ${event.price}

${event.description}

👥 Organizzato da ${event.organizer}

#ChiFacimu #EventiCalabria #${event.city}`;
            }

            // Fallback share (copy to clipboard)
            fallbackShare(text) {
                this.fallbackCopy(text);
            }

            // Fallback copy method
            fallbackCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    this.showNotification('Testo copiato negli appunti!', 'success');
                } catch (error) {
                    console.error('Fallback copy failed:', error);
                    this.showNotification('Impossibile copiare il testo', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }

            // Show notification
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg font-medium text-white transition-all duration-300 ${
                    type === 'success' ? 'bg-green-600' : 
                    type === 'error' ? 'bg-red-600' : 
                    'bg-blue-600'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Initialize the application
        let app;
        
        // Aspetta che tutto sia caricato prima di inizializzare
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Inizializzazione app...');
            try {
                app = new ChiFacimuApp();
                console.log('✅ App inizializzata con successo!');
            } catch (error) {
                console.error('❌ Errore nell\'inizializzazione:', error);
                // Fallback: mostra almeno gli eventi di esempio
                document.getElementById('eventsGrid').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Caricamento in corso...</h3>
                        <p class="text-gray-500">Se il problema persiste, ricarica la pagina</p>
                    </div>
                `;
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966c1a4634e19616',t:'MTc1Mzc4NjcyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
